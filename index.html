<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1A2332"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="description" content="Helix Industries Production & Dispatch Tracker"/>
  <link rel="manifest" href="manifest.json"/>
  <title>HIPL Â· Production & Dispatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800;900&family=Barlow:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold:        #F5A623;
      --gold-light:  #FFD06B;
      --gold-dim:    rgba(245,166,35,0.15);
      --gold-border: rgba(245,166,35,0.28);
      --slate-900:   #111923;
      --slate-800:   #1A2332;
      --slate-700:   #243044;
      --slate-600:   #2D3B52;
      --slate-500:   #3D4F63;
      --slate-400:   #536070;
      --white:       #FFFFFF;
      --off:         rgba(255,255,255,0.06);
      --border:      rgba(255,255,255,0.07);
      --border-md:   rgba(255,255,255,0.12);
      --text-dim:    rgba(255,255,255,0.45);
      --text-mid:    rgba(255,255,255,0.7);
      --green:       #38A169;
      --green-dim:   rgba(56,161,105,0.12);
      --green-bdr:   rgba(56,161,105,0.25);
      --red:         #E53E3E;
      --red-dim:     rgba(229,62,62,0.1);
      --red-bdr:     rgba(229,62,62,0.22);
      --r:           10px;
      --r-sm:        7px;
    }

    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Barlow', sans-serif;
      background: var(--slate-800);
      color: var(--white);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ TEXTURE LAYER â”€â”€ */
    body::before {
      content:'';
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(ellipse 60% 50% at 5% 0%,   rgba(245,166,35,0.07) 0%, transparent 70%),
        radial-gradient(ellipse 40% 60% at 95% 100%, rgba(17,25,35,0.9)   0%, transparent 70%),
        repeating-linear-gradient(135deg, transparent 0, transparent 48px, rgba(255,255,255,0.013) 48px, rgba(255,255,255,0.013) 49px),
        repeating-linear-gradient(45deg,  transparent 0, transparent 48px, rgba(255,255,255,0.008) 48px, rgba(255,255,255,0.008) 49px);
    }

    /* â”€â”€ HEADER â”€â”€ */
    .hdr {
      position: sticky; top:0; z-index:200;
      background: rgba(17,25,35,0.92);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
    }
    .hdr-inner {
      max-width: 860px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; height: 62px;
    }
    .logo { display:flex; align-items:center; gap:12px; }
    .logo-mark {
      width:38px; height:38px; flex-shrink:0;
      display:grid; grid-template-columns:1fr 1fr; gap:3px;
    }
    .lm-tl { background:var(--slate-600); border-radius:2px 0 0 0; }
    .lm-tr { background:var(--gold);      border-radius:0 2px 0 0; position:relative; overflow:hidden; }
    .lm-tr::after { content:''; position:absolute; bottom:0; right:0; width:0; height:0; border-style:solid; border-width:0 0 12px 12px; border-color:transparent transparent var(--slate-800) transparent; }
    .lm-bl { background:var(--gold);      border-radius:0 0 0 2px; }
    .lm-br { background:var(--slate-600); border-radius:0 0 2px 0; }
    .logo-words h1 {
      font-family:'Barlow Condensed',sans-serif;
      font-size:19px; font-weight:800;
      letter-spacing:3.5px; text-transform:uppercase;
      color:var(--white); line-height:1;
    }
    .logo-words p {
      font-size:9px; letter-spacing:2.5px; text-transform:uppercase;
      color:var(--gold); font-weight:600; margin-top:3px;
    }
    .hdr-pill {
      background:linear-gradient(135deg,var(--gold),#C4841A);
      color:var(--slate-900);
      font-family:'Barlow Condensed',sans-serif;
      font-size:10px; font-weight:800;
      letter-spacing:2px; text-transform:uppercase;
      padding:5px 12px; border-radius:20px;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    main {
      position:relative; z-index:1;
      max-width:860px; margin:0 auto;
      padding:28px 18px 100px;
    }

    /* â”€â”€ PAGE HEADING â”€â”€ */
    .pg-head { margin-bottom:24px; }
    .pg-head h2 {
      font-family:'Barlow Condensed',sans-serif;
      font-size:34px; font-weight:900;
      letter-spacing:0.5px; line-height:1.05;
    }
    .pg-head h2 em { color:var(--gold); font-style:normal; }
    .pg-head p { font-size:13px; color:var(--text-dim); margin-top:5px; font-weight:300; letter-spacing:0.3px; }

    /* â”€â”€ OFFLINE BANNER â”€â”€ */
    .offline-bar {
      display:none; align-items:center; gap:8px;
      background:var(--red-dim); border:1px solid var(--red-bdr);
      border-radius:var(--r-sm); padding:9px 14px;
      font-size:12px; color:#FC8181; margin-bottom:16px;
    }
    .offline-bar.on { display:flex; }

    /* â”€â”€ DATE STRIP â”€â”€ */
    .date-strip {
      display:flex; align-items:center; gap:0;
      background:linear-gradient(135deg, rgba(245,166,35,0.12), rgba(245,166,35,0.04));
      border:1px solid var(--gold-border);
      border-radius:var(--r); padding:14px 18px;
      margin-bottom:20px;
    }
    .date-icon-box {
      width:36px; height:36px; flex-shrink:0;
      background:linear-gradient(135deg,var(--gold),#C4841A);
      border-radius:7px; display:flex; align-items:center; justify-content:center;
      font-size:16px; margin-right:14px;
    }
    .date-lbl { font-size:10px; letter-spacing:2.5px; text-transform:uppercase; color:var(--gold); font-weight:700; margin-bottom:3px; }
    .date-strip input[type="date"] {
      background:transparent; border:none; outline:none;
      font-family:'Barlow Condensed',sans-serif;
      font-size:21px; font-weight:700; color:var(--white);
      letter-spacing:1px; cursor:pointer; padding:0; width:auto;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter:invert(1) sepia(1) saturate(4) hue-rotate(5deg);
      cursor:pointer; opacity:0.6; margin-left:8px;
    }

    /* â”€â”€ CARDS â”€â”€ */
    .card {
      background:var(--off); border:1px solid var(--border);
      border-radius:var(--r); overflow:hidden; margin-bottom:16px;
    }
    .card-hdr {
      padding:13px 18px; background:rgba(255,255,255,0.025);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:10px;
    }
    .card-num {
      width:24px; height:24px; flex-shrink:0;
      background:linear-gradient(135deg,var(--gold),#C4841A);
      border-radius:50%; display:flex; align-items:center; justify-content:center;
      font-family:'Barlow Condensed',sans-serif;
      font-size:12px; font-weight:900; color:var(--slate-900);
    }
    .card-hdr h3 {
      font-family:'Barlow Condensed',sans-serif;
      font-size:14px; font-weight:700;
      letter-spacing:2.5px; text-transform:uppercase;
      color:rgba(255,255,255,0.8);
    }
    .card-body { padding:18px; }

    /* â”€â”€ FORM GRID â”€â”€ */
    .fg { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .fg.fg3 { grid-template-columns:1fr 1fr 1fr; }
    .ff { display:flex; flex-direction:column; gap:6px; }
    .ff.full { grid-column:1/-1; }

    .fl {
      font-size:10px; letter-spacing:2px; text-transform:uppercase;
      font-weight:700; color:var(--text-dim);
      display:flex; align-items:center; gap:3px;
    }
    .fl .req { color:var(--gold); font-size:13px; line-height:1; }

    select, input[type="text"], input[type="number"] {
      width:100%; background:rgba(255,255,255,0.055);
      border:1px solid rgba(255,255,255,0.09);
      border-radius:var(--r-sm); padding:10px 13px;
      color:var(--white); font-family:'Barlow',sans-serif;
      font-size:14px; font-weight:500; outline:none;
      transition:border-color .18s, box-shadow .18s, background .18s;
      -webkit-appearance:none; appearance:none;
    }
    select {
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23F5A623' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 11px center;
      padding-right:34px; cursor:pointer;
    }
    select option { background:var(--slate-700); color:var(--white); }
    select:focus, input:focus {
      border-color:var(--gold);
      background:rgba(245,166,35,0.07);
      box-shadow:0 0 0 3px rgba(245,166,35,0.1);
    }
    select.err, input.err { border-color:var(--red); box-shadow:0 0 0 3px rgba(229,62,62,0.1); }
    select:disabled { opacity:0.38; cursor:not-allowed; }
    .emsg { font-size:11px; color:#FC8181; }

    .other-input { display:none; margin-top:7px; }

    /* â”€â”€ PROD / DISP â”€â”€ */
    .pd-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .pd-box { border-radius:var(--r-sm); padding:15px 16px; }
    .pd-box.prod { background:var(--green-dim); border:1px solid var(--green-bdr); }
    .pd-box.disp { background:var(--red-dim);   border:1px solid var(--red-bdr);   }
    .pd-box.prod .fl { color:rgba(104,211,145,0.85); }
    .pd-box.disp .fl { color:rgba(252,129,129,0.85); }
    .pd-box.prod input { border-color:var(--green-bdr); }
    .pd-box.disp input { border-color:var(--red-bdr); }
    .pd-box.prod input:focus { border-color:var(--green); box-shadow:0 0 0 3px rgba(56,161,105,0.15); }
    .pd-box.disp input:focus { border-color:var(--red);   box-shadow:0 0 0 3px rgba(229,62,62,0.12); }
    .pd-hint { font-size:11px; margin-top:5px; }
    .prod .pd-hint { color:rgba(56,161,105,0.55); }
    .disp .pd-hint { color:rgba(229,62,62,0.45);  }

    /* â”€â”€ CONVERSION PREVIEW â”€â”€ */
    .conv-preview {
      display:none; margin-top:12px;
      background:rgba(245,166,35,0.07); border:1px solid var(--gold-border);
      border-radius:var(--r-sm); padding:10px 14px;
      font-size:12px; color:var(--gold); letter-spacing:0.3px;
      line-height:1.6;
    }
    .conv-preview.show { display:block; }

    /* â”€â”€ ACTION ROW â”€â”€ */
    .actions { display:flex; gap:10px; margin-top:20px; }
    .btn-primary {
      flex:1; background:linear-gradient(135deg,var(--gold) 0%,#C4841A 100%);
      border:none; border-radius:var(--r-sm); padding:14px 20px;
      color:var(--slate-900); font-family:'Barlow Condensed',sans-serif;
      font-size:15px; font-weight:900; letter-spacing:2px; text-transform:uppercase;
      cursor:pointer; transition:transform .15s, box-shadow .15s;
      position:relative; overflow:hidden;
    }
    .btn-primary::after {
      content:''; position:absolute; inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.18),transparent);
      opacity:0; transition:opacity .18s;
    }
    .btn-primary:hover::after { opacity:1; }
    .btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 28px rgba(245,166,35,0.3); }
    .btn-primary:active { transform:translateY(0); }
    .btn-primary:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    .btn-ghost {
      background:transparent; border:1px solid var(--border-md);
      border-radius:var(--r-sm); padding:14px 18px;
      color:var(--text-dim); font-family:'Barlow Condensed',sans-serif;
      font-size:13px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
      cursor:pointer; transition:border-color .15s, color .15s;
    }
    .btn-ghost:hover { border-color:var(--border-md); color:var(--text-mid); }

    /* â”€â”€ SPINNER â”€â”€ */
    .spin {
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(26,35,50,0.3); border-top-color:var(--slate-900);
      border-radius:50%; animation:spin .65s linear infinite; vertical-align:middle;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* â”€â”€ SETTINGS â”€â”€ */
    .settings-wrap { margin-top:16px; }
    .settings-toggle {
      display:flex; align-items:center; gap:9px;
      background:var(--off); border:1px solid var(--border);
      border-radius:var(--r-sm); padding:11px 15px;
      font-size:12px; color:var(--text-dim); cursor:pointer;
      letter-spacing:0.3px; transition:border-color .15s, color .15s;
      user-select:none;
    }
    .settings-toggle:hover { border-color:var(--border-md); color:var(--text-mid); }
    .settings-toggle .arr { transition:transform .2s; font-size:10px; }
    .settings-toggle.open .arr { transform:rotate(90deg); }
    .settings-panel {
      display:none; flex-direction:column; gap:14px;
      background:var(--off); border:1px solid var(--border);
      border-top:none; border-radius:0 0 var(--r-sm) var(--r-sm); padding:18px;
    }
    .settings-panel.open { display:flex; }
    .settings-panel label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); font-weight:700; display:block; margin-bottom:5px; }
    .settings-note { font-size:12px; color:var(--text-dim); line-height:1.7; }
    .settings-note strong { color:var(--gold); }
    .script-link { color:var(--gold); font-size:12px; text-decoration:underline; cursor:pointer; }
    .btn-save-cfg {
      align-self:flex-start; background:transparent;
      border:1px solid var(--gold-border); border-radius:var(--r-sm);
      padding:9px 18px; color:var(--gold);
      font-family:'Barlow Condensed',sans-serif; font-size:13px; font-weight:700;
      letter-spacing:1.5px; text-transform:uppercase; cursor:pointer;
      transition:background .15s;
    }
    .btn-save-cfg:hover { background:var(--gold-dim); }

    /* â”€â”€ RECENT LOG â”€â”€ */
    .log-section { margin-top:32px; }
    .log-title {
      font-family:'Barlow Condensed',sans-serif;
      font-size:12px; font-weight:700; letter-spacing:3px;
      text-transform:uppercase; color:rgba(255,255,255,0.3);
      margin-bottom:12px; display:flex; align-items:center; gap:10px;
    }
    .log-title::after { content:''; flex:1; height:1px; background:var(--border); }
    .log-empty { text-align:center; padding:28px; font-size:13px; color:rgba(255,255,255,0.2); }
    .log-item {
      display:flex; align-items:center; gap:10px;
      background:var(--off); border:1px solid var(--border);
      border-radius:var(--r-sm); padding:11px 14px; margin-bottom:8px;
      font-size:13px; animation:fadeUp .25s ease;
    }
    @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
    .log-badge {
      background:var(--gold-dim); border:1px solid var(--gold-border);
      color:var(--gold); font-family:'Barlow Condensed',sans-serif;
      font-size:10px; font-weight:800; letter-spacing:1px;
      padding:3px 8px; border-radius:4px;
      white-space:nowrap; text-transform:uppercase; flex-shrink:0;
    }
    .log-info { flex:1; min-width:0; }
    .log-info strong { color:var(--white); font-size:13px; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .log-info span { font-size:11px; color:var(--text-dim); }
    .log-nums { display:flex; gap:8px; align-items:center; flex-shrink:0; }
    .lp { color:#68D391; font-weight:700; font-size:12px; }
    .ld { color:#FC8181; font-weight:700; font-size:12px; }
    .log-sep { color:rgba(255,255,255,0.15); font-size:10px; }
    .log-time { font-size:11px; color:rgba(255,255,255,0.25); white-space:nowrap; flex-shrink:0; }

    /* â”€â”€ MODAL â”€â”€ */
    .modal-overlay {
      display:none; position:fixed; inset:0; z-index:500;
      background:rgba(0,0,0,0.88); backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px); padding:20px; overflow-y:auto;
    }
    .modal-overlay.open { display:block; }
    .modal-box {
      max-width:700px; margin:40px auto;
      background:var(--slate-700); border:1px solid var(--border);
      border-radius:var(--r); overflow:hidden;
    }
    .modal-hdr {
      padding:18px 22px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-hdr h3 { font-family:'Barlow Condensed',sans-serif; font-size:17px; font-weight:800; letter-spacing:1px; }
    .modal-close { background:none; border:none; color:var(--text-dim); font-size:22px; cursor:pointer; line-height:1; }
    .modal-body { padding:22px; }
    .modal-note { font-size:13px; color:var(--text-dim); margin-bottom:16px; line-height:1.7; }
    .modal-steps { font-size:13px; color:var(--text-mid); line-height:2; margin-bottom:16px; }
    .modal-steps strong { color:var(--gold); }
    pre#scriptPre {
      background:#0D1117; border:1px solid rgba(255,255,255,0.07);
      border-radius:8px; padding:16px; font-size:11px; overflow-x:auto;
      color:#c9d1d9; line-height:1.65; white-space:pre-wrap; max-height:360px; overflow-y:auto;
    }
    .btn-copy {
      margin-top:12px; background:linear-gradient(135deg,var(--gold),#C4841A);
      border:none; border-radius:8px; padding:10px 20px;
      color:var(--slate-900); font-family:'Barlow Condensed',sans-serif;
      font-weight:800; letter-spacing:1.5px; cursor:pointer; font-size:13px;
    }

    /* â”€â”€ TOAST â”€â”€ */
    .toast-wrap {
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
      z-index:999; display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    .toast {
      display:flex; align-items:center; gap:9px;
      background:var(--slate-600); border:1px solid var(--border);
      border-radius:40px; padding:11px 20px;
      font-size:13px; font-weight:500; box-shadow:0 8px 32px rgba(0,0,0,0.5);
      animation:fadeUp .25s ease; max-width:360px; text-align:center;
    }
    .toast.ok  { background:rgba(56,161,105,0.18); border-color:rgba(56,161,105,0.35); }
    .toast.err { background:rgba(229,62,62,0.15);  border-color:rgba(229,62,62,0.35);  }
    .toast.inf { background:rgba(245,166,35,0.12); border-color:rgba(245,166,35,0.3);  }
    .t-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .toast.ok  .t-dot { background:var(--green); }
    .toast.err .t-dot { background:var(--red); }
    .toast.inf .t-dot { background:var(--gold); animation:blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media(max-width:580px) {
      .fg, .fg3 { grid-template-columns:1fr; }
      .pd-grid { grid-template-columns:1fr; }
      .pg-head h2 { font-size:27px; }
      .hdr-pill { display:none; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-inner">
    <div class="logo">
      <div class="logo-mark">
        <div class="lm-tl"></div>
        <div class="lm-tr"></div>
        <div class="lm-bl"></div>
        <div class="lm-br"></div>
      </div>
      <div class="logo-words">
        <h1>Helix Industries</h1>
        <p>Quality Redefined</p>
      </div>
    </div>
    <div class="hdr-pill">Prod &amp; Dispatch</div>
  </div>
</header>

<main>
  <div class="pg-head">
    <h2>Production &amp; <em>Dispatch</em> Entry</h2>
    <p>Log daily manufacturing output and material dispatch â€” syncs to Google Sheets</p>
  </div>

  <div class="offline-bar" id="offlineBar">
    <span>âš¡</span> You're offline â€” entries will queue and sync automatically when reconnected.
  </div>

  <!-- DATE -->
  <div class="date-strip">
    <div class="date-icon-box">ğŸ“…</div>
    <div>
      <div class="date-lbl">Entry Date</div>
      <input type="date" id="entryDate"/>
    </div>
  </div>

  <!-- CARD 1: MATERIAL -->
  <div class="card">
    <div class="card-hdr">
      <div class="card-num">1</div>
      <h3>Material Identification</h3>
    </div>
    <div class="card-body">
      <div class="fg">

        <!-- Machine -->
        <div class="ff">
          <label class="fl">Machine Name <span class="req">*</span></label>
          <select id="sMachine" onchange="onMachine()">
            <option value="">â€” Select Machine â€”</option>
            <option value="Apollo">Apollo</option>
            <option value="Parijatha PBM+">Parijatha PBM+</option>
            <option value="Rubber Mould">Rubber Mould</option>
            <option value="Columbia">Columbia</option>
            <option value="Other">Other</option>
          </select>
          <span class="emsg" id="eMachine"></span>
        </div>

        <!-- Product -->
        <div class="ff">
          <label class="fl">Product <span class="req">*</span></label>
          <select id="sProduct" disabled onchange="onProduct()">
            <option value="">â€” Select Machine First â€”</option>
          </select>
          <span class="emsg" id="eProduct"></span>
        </div>

        <!-- Thickness -->
        <div class="ff">
          <label class="fl">Thickness <span class="req">*</span></label>
          <select id="sThickness" onchange="onThickness()">
            <option value="">â€” Select Thickness â€”</option>
            <option value="20 MM">20 MM</option>
            <option value="25 MM">25 MM</option>
            <option value="30 MM">30 MM</option>
            <option value="60 MM">60 MM</option>
            <option value="75 MM">75 MM</option>
            <option value="80 MM">80 MM</option>
            <option value="100 MM">100 MM</option>
            <option value="150 MM">150 MM</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" id="iThicknessOther" class="other-input" placeholder="Enter thickness valueâ€¦"/>
          <span class="emsg" id="eThickness"></span>
        </div>

        <!-- Grade -->
        <div class="ff">
          <label class="fl">Grade</label>
          <select id="sGrade">
            <option value="">â€” None / N/A â€”</option>
            <option value="M-7.5">M-7.5</option>
            <option value="M-12.5">M-12.5</option>
            <option value="M-25">M-25</option>
            <option value="M-30">M-30</option>
            <option value="M-35">M-35</option>
            <option value="M-40">M-40</option>
            <option value="M-50">M-50</option>
          </select>
        </div>

        <!-- Color -->
        <div class="ff full">
          <label class="fl">Color</label>
          <select id="sColor" onchange="onColor()">
            <option value="">â€” Select Color â€”</option>
            <option value="Grey">Grey</option>
            <option value="Dark Grey">Dark Grey</option>
            <option value="Red">Red</option>
            <option value="Yellow">Yellow</option>
            <option value="Chocolate">Chocolate</option>
            <option value="Orange">Orange</option>
            <option value="White">White</option>
            <option value="Blue">Blue</option>
            <option value="Green">Green</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" id="iColorOther" class="other-input" placeholder="Enter color nameâ€¦"/>
        </div>

      </div><!-- /fg -->
    </div><!-- /card-body -->
  </div><!-- /card -->

  <!-- CARD 2: QUANTITIES -->
  <div class="card">
    <div class="card-hdr">
      <div class="card-num">2</div>
      <h3>Quantities</h3>
    </div>
    <div class="card-body">
      <div class="pd-grid">
        <div class="pd-box prod">
          <label class="fl">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
            Production (Pieces)
          </label>
          <input type="number" id="iProd" placeholder="0" min="0" oninput="updateConversion()"/>
          <div class="pd-hint">Manufactured today</div>
        </div>
        <div class="pd-box disp">
          <label class="fl">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/></svg>
            Dispatch (Pieces)
          </label>
          <input type="number" id="iDisp" placeholder="0" min="0" oninput="updateConversion()"/>
          <div class="pd-hint">Dispatched today</div>
        </div>
      </div>

      <!-- Conversion Preview -->
      <div class="conv-preview" id="convPreview"></div>

    </div>
  </div>

  <!-- SETTINGS -->
  <div class="settings-wrap">
    <div class="settings-toggle" id="settingsToggle" onclick="toggleSettings()">
      <span class="arr">â–¶</span>
      <span>âš™ Google Sheets Integration</span>
      <span id="cfgStatus" style="margin-left:auto;font-size:11px;"></span>
    </div>
    <div class="settings-panel" id="settingsPanel">
      <div>
        <label>Google Apps Script Web App URL</label>
        <input type="text" id="iScriptUrl" placeholder="https://script.google.com/macros/s/â€¦/exec"/>
      </div>
      <div class="settings-note">
        <strong>How to connect:</strong><br>
        1. Open your Google Sheet â†’ Extensions â†’ Apps Script<br>
        2. Paste the provided script (link below) â†’ Save<br>
        3. Deploy â†’ New Deployment â†’ Web App<br>
        &nbsp;&nbsp;&nbsp;Â· Execute as: <strong>Me</strong><br>
        &nbsp;&nbsp;&nbsp;Â· Who has access: <strong>Anyone with Google Account</strong><br>
        4. Copy the deployment URL and paste above<br><br>
        <span class="script-link" onclick="openModal()">ğŸ“‹ View &amp; copy the Google Apps Script â†’</span>
      </div>
      <button class="btn-save-cfg" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="btn-ghost" onclick="resetForm()">â†º Reset</button>
    <button class="btn-primary" id="btnSubmit" onclick="submitEntry()">Submit Entry</button>
  </div>

  <!-- RECENT LOG -->
  <div class="log-section">
    <div class="log-title">Recent Entries</div>
    <div id="logList"></div>
  </div>
</main>

<!-- SCRIPT MODAL -->
<div class="modal-overlay" id="scriptModal">
  <div class="modal-box">
    <div class="modal-hdr">
      <h3>Google Apps Script â€” Setup Code</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="modal-note">Copy this entire script into your Google Sheet's Apps Script editor, then deploy it as a Web App.</p>
      <div class="modal-steps">
        <strong>Extensions â†’ Apps Script â†’ Paste â†’ Save (ğŸ’¾) â†’ Deploy â†’ New Deployment â†’ Web App</strong><br>
        Execute as: <strong>Me</strong> &nbsp;|&nbsp; Who has access: <strong>Anyone with Google Account</strong>
      </div>
      <pre id="scriptPre"></pre>
      <button class="btn-copy" onclick="copyScript()">ğŸ“‹ Copy Script to Clipboard</button>
    </div>
  </div>
</div>

<!-- TOASTS -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MACHINE_PRODUCTS = {
  'Apollo': [
    'Hexagon','8x8 Quad','8x4','Kerbstone Round',
    'Kerbstone Chamfered','Kerbstone Bullnose'
  ],
  'Parijatha PBM+': [
    'Hexagon','Zigzag','I-Shape','8x4','Tricon','S-Paver'
  ],
  'Rubber Mould': [
    'Jumbo','Zigzag','Euphrates','River Quad','3D Hexa','Cobble',
    '8x4','4x4','Cobble 4.5"','X-Block','Cover Block Big',
    'Cover Block Small','36 Striker','Cross Strip','Matrix','Riveira',
    'BB Bali','BB Aruba','BB Maui','BB Maldives','BB Ibiza',
    'BB Barbados','Cool Roof Tile','Drain Channel'
  ],
  'Columbia': [],
  'Other': []
};

// Conversion: pieces per sq ft â€” key: "Machine|Product"
// sqft = pieces / factor
const CONV = {
  'Apollo|Hexagon':             2.50,
  'Apollo|8x8 Quad':            2.25,
  'Apollo|8x4':                 4.50,
  'Apollo|Kerbstone Round':     1.00,
  'Apollo|Kerbstone Chamfered': 1.00,
  'Apollo|Kerbstone Bullnose':  1.00,
  'Parijatha PBM+|Hexagon':     2.50,
  'Parijatha PBM+|Zigzag':      3.50,
  'Parijatha PBM+|I-Shape':     3.25,
  'Parijatha PBM+|8x4':         4.50,
  'Parijatha PBM+|Tricon':      2.90,
  'Parijatha PBM+|S-Paver':     4.50,
  'Rubber Mould|Jumbo':         1.80,
  'Rubber Mould|Zigzag':        2.80,
  'Rubber Mould|Euphrates':     2.50,
  'Rubber Mould|River Quad':    2.25,
  'Rubber Mould|3D Hexa':       2.50,
  'Rubber Mould|Cobble':        2.25,
  'Rubber Mould|8x4':           4.50,
  'Rubber Mould|4x4':           9.00,
  'Rubber Mould|Cobble 4.5"':   7.11,
  'Rubber Mould|X-Block':       1.44,
  'Rubber Mould|36 Striker':    1.00,
  'Rubber Mould|Cross Strip':   1.00,
  'Rubber Mould|Matrix':        1.00,
  'Rubber Mould|BB Bali':       2.25,
  'Rubber Mould|BB Aruba':      2.25,
  'Rubber Mould|BB Maui':       2.25,
  'Rubber Mould|BB Maldives':   2.25,
  'Rubber Mould|BB Ibiza':      2.25,
  'Rubber Mould|BB Barbados':   2.25,
  'Rubber Mould|Cool Roof Tile':1.00,
  'Rubber Mould|Drain Channel': 1.00
  // Cover Block Big, Cover Block Small, Riveira â€” no conversion factor provided
};

const SQM_PER_SQFT = 0.092903;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Set today's date
  const t = new Date();
  document.getElementById('entryDate').value =
    `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;

  // Load saved settings
  const url = localStorage.getItem('hipl_url') || '';
  document.getElementById('iScriptUrl').value = url;
  updateCfgStatus();

  // Render log
  renderLog();

  // Offline detection
  const ob = document.getElementById('offlineBar');
  window.addEventListener('offline', () => ob.classList.add('on'));
  window.addEventListener('online',  () => { ob.classList.remove('on'); syncQueue(); });
  if (!navigator.onLine) ob.classList.add('on');

  // Service worker message (sync trigger)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', e => {
      if (e.data?.type === 'SYNC_NOW') syncQueue();
    });
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
});

function updateCfgStatus() {
  const el = document.getElementById('cfgStatus');
  const url = localStorage.getItem('hipl_url') || '';
  el.textContent = url ? 'ğŸŸ¢ Connected' : 'ğŸ”´ Not configured';
  el.style.color  = url ? '#68D391' : '#FC8181';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MACHINE / PRODUCT CASCADE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMachine() {
  const machine = document.getElementById('sMachine').value;
  const sel     = document.getElementById('sProduct');
  clearErr('eMachine');
  updateConversion();

  if (!machine) {
    sel.innerHTML = '<option value="">â€” Select Machine First â€”</option>';
    sel.disabled  = true;
    return;
  }

  const products = MACHINE_PRODUCTS[machine] || [];
  let html = '<option value="">â€” Select Product â€”</option>';
  products.forEach(p => { html += `<option value="${p}">${p}</option>`; });
  html += '<option value="__custom__">Other / Customâ€¦</option>';
  sel.innerHTML = html;
  sel.disabled  = false;
}

function onProduct() {
  const sel = document.getElementById('sProduct');
  clearErr('eProduct');
  if (sel.value === '__custom__') {
    const name = prompt('Enter custom product name:');
    if (name && name.trim()) {
      const opt = new Option(name.trim(), name.trim(), true, true);
      sel.add(opt); sel.value = name.trim();
    } else { sel.value = ''; }
  }
  updateConversion();
}

function onThickness() {
  clearErr('eThickness');
  const v  = document.getElementById('sThickness').value;
  const el = document.getElementById('iThicknessOther');
  el.style.display = v === 'Other' ? 'block' : 'none';
}

function onColor() {
  const v  = document.getElementById('sColor').value;
  const el = document.getElementById('iColorOther');
  el.style.display = v === 'Other' ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVERSION PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateConversion() {
  const machine = document.getElementById('sMachine').value;
  const product = document.getElementById('sProduct').value;
  const prod    = parseFloat(document.getElementById('iProd').value) || 0;
  const disp    = parseFloat(document.getElementById('iDisp').value) || 0;
  const preview = document.getElementById('convPreview');

  const key    = `${machine}|${product}`;
  const factor = CONV[key];

  if (!factor || (!prod && !disp)) {
    preview.classList.remove('show');
    return;
  }

  const prodSqft = prod > 0 ? (prod / factor).toFixed(2) : null;
  const dispSqft = disp > 0 ? (disp / factor).toFixed(2) : null;
  const prodSqm  = prodSqft ? (prodSqft * SQM_PER_SQFT).toFixed(3) : null;
  const dispSqm  = dispSqft ? (dispSqft * SQM_PER_SQFT).toFixed(3) : null;

  let html = `<strong style="color:var(--gold)">ğŸ“ Conversion Preview</strong> &nbsp;(${factor} pcs/sq ft)<br>`;
  if (prodSqft) html += `Production: ${prod} pcs = <strong>${prodSqft} sq ft</strong> / ${prodSqm} sq mtr&nbsp;&nbsp;`;
  if (dispSqft) html += `&nbsp;|&nbsp;&nbsp;Dispatch: ${disp} pcs = <strong>${dispSqft} sq ft</strong> / ${dispSqm} sq mtr`;

  preview.innerHTML = html;
  preview.classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VALIDATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validate() {
  let ok = true;
  if (!document.getElementById('sMachine').value)  { setErr('eMachine','Machine is required.');   ok=false; }
  if (!document.getElementById('sProduct').value)  { setErr('eProduct','Product is required.');   ok=false; }
  const thick = document.getElementById('sThickness').value;
  if (!thick) { setErr('eThickness','Thickness is required.'); ok=false; }
  if (thick === 'Other' && !document.getElementById('iThicknessOther').value.trim()) {
    setErr('eThickness','Please specify the thickness.'); ok=false;
  }
  const p = parseFloat(document.getElementById('iProd').value)||0;
  const d = parseFloat(document.getElementById('iDisp').value)||0;
  if (!p && !d) { toast('Enter at least one non-zero quantity.','err'); ok=false; }
  return ok;
}
function setErr(id,msg){ document.getElementById(id).textContent=msg; }
function clearErr(id)  { document.getElementById(id).textContent=''; }
function clearAllErr() { ['eMachine','eProduct','eThickness'].forEach(clearErr); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD ENTRY OBJECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEntry() {
  const machine  = document.getElementById('sMachine').value;
  const product  = document.getElementById('sProduct').value;
  const thickRaw = document.getElementById('sThickness').value;
  const thick    = thickRaw === 'Other' ? document.getElementById('iThicknessOther').value.trim() : thickRaw;
  const colorRaw = document.getElementById('sColor').value;
  const color    = colorRaw === 'Other' ? document.getElementById('iColorOther').value.trim() : colorRaw;
  const prod     = parseFloat(document.getElementById('iProd').value)||0;
  const disp     = parseFloat(document.getElementById('iDisp').value)||0;
  const factor   = CONV[`${machine}|${product}`] || null;

  return {
    date:      document.getElementById('entryDate').value,
    machine, product, thickness: thick,
    grade:     document.getElementById('sGrade').value,
    color,
    production: prod, dispatch: disp,
    sqftFactor: factor,
    prodSqft:  factor && prod ? +(prod / factor).toFixed(4) : null,
    dispSqft:  factor && disp ? +(disp / factor).toFixed(4) : null,
    prodSqm:   factor && prod ? +(prod / factor * SQM_PER_SQFT).toFixed(4) : null,
    dispSqm:   factor && disp ? +(disp / factor * SQM_PER_SQFT).toFixed(4) : null,
    timestamp: new Date().toISOString()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitEntry() {
  clearAllErr();
  if (!validate()) return;

  const entry   = buildEntry();
  const btn     = document.getElementById('btnSubmit');
  const scriptUrl = localStorage.getItem('hipl_url');

  btn.disabled   = true;
  btn.innerHTML  = '<span class="spin"></span> Submittingâ€¦';

  // Save locally always
  saveLocal(entry);

  if (!scriptUrl) {
    toast('Saved locally. Configure Google Sheets to sync.','inf');
    finishSubmit(entry, btn);
    return;
  }

  if (!navigator.onLine) {
    queueOffline(entry);
    toast('Offline â€” queued for sync when reconnected.','inf');
    finishSubmit(entry, btn);
    return;
  }

  try {
    await fetch(scriptUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(entry)
    });
    toast('âœ“ Entry submitted to Google Sheets!','ok');
  } catch(e) {
    queueOffline(entry);
    toast('Error â€” entry queued for retry.','err');
  }

  finishSubmit(entry, btn);
}

function finishSubmit(entry, btn) {
  btn.disabled  = false;
  btn.innerHTML = 'Submit Entry';
  renderLog();
  resetForm();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveLocal(entry) {
  const arr = JSON.parse(localStorage.getItem('hipl_entries')||'[]');
  arr.unshift(entry);
  if (arr.length > 60) arr.splice(60);
  localStorage.setItem('hipl_entries', JSON.stringify(arr));
}

function queueOffline(entry) {
  const q = JSON.parse(localStorage.getItem('hipl_queue')||'[]');
  q.push(entry);
  localStorage.setItem('hipl_queue', JSON.stringify(q));
}

async function syncQueue() {
  const url = localStorage.getItem('hipl_url');
  if (!url) return;
  const q = JSON.parse(localStorage.getItem('hipl_queue')||'[]');
  if (!q.length) return;
  toast(`Syncing ${q.length} queued entr${q.length>1?'ies':'y'}â€¦`,'inf');
  const fail = [];
  for (const e of q) {
    try {
      await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(e)});
    } catch { fail.push(e); }
  }
  localStorage.setItem('hipl_queue', JSON.stringify(fail));
  if (q.length - fail.length > 0) toast(`âœ“ ${q.length-fail.length} entr${q.length-fail.length>1?'ies':'y'} synced!`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetForm() {
  document.getElementById('sMachine').value   = '';
  document.getElementById('sProduct').innerHTML = '<option value="">â€” Select Machine First â€”</option>';
  document.getElementById('sProduct').disabled  = true;
  document.getElementById('sThickness').value  = '';
  document.getElementById('iThicknessOther').style.display = 'none';
  document.getElementById('iThicknessOther').value = '';
  document.getElementById('sGrade').value   = '';
  document.getElementById('sColor').value   = '';
  document.getElementById('iColorOther').style.display = 'none';
  document.getElementById('iColorOther').value  = '';
  document.getElementById('iProd').value    = '';
  document.getElementById('iDisp').value    = '';
  document.getElementById('convPreview').classList.remove('show');
  clearAllErr();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLog() {
  const arr  = JSON.parse(localStorage.getItem('hipl_entries')||'[]');
  const list = document.getElementById('logList');
  if (!arr.length) {
    list.innerHTML = '<div class="log-empty">No entries yet â€” submit your first record above.</div>';
    return;
  }
  list.innerHTML = arr.slice(0,12).map(e => {
    const d   = new Date(e.timestamp);
    const dt  = new Date(e.date).toLocaleDateString('en-IN',{day:'numeric',month:'short'});
    const tm  = d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
    const sub = [e.thickness, e.grade, e.color].filter(Boolean).join(' Â· ');
    return `
      <div class="log-item">
        <span class="log-badge">${e.machine.split(' ')[0]}</span>
        <div class="log-info">
          <strong>${e.product}</strong>
          <span>${sub}</span>
        </div>
        <div class="log-nums">
          <span class="lp">â†‘${e.production}</span>
          <span class="log-sep">|</span>
          <span class="ld">â†“${e.dispatch}</span>
        </div>
        <span class="log-time">${dt} ${tm}</span>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSettings() {
  document.getElementById('settingsToggle').classList.toggle('open');
  document.getElementById('settingsPanel').classList.toggle('open');
}
function saveSettings() {
  const url = document.getElementById('iScriptUrl').value.trim();
  localStorage.setItem('hipl_url', url);
  updateCfgStatus();
  toast('âœ“ Settings saved!','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='ok') {
  const wrap = document.getElementById('toastWrap');
  const el   = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<div class="t-dot"></div><span>${msg}</span>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(),300); }, 3600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal()  {
  document.getElementById('scriptPre').textContent = APPS_SCRIPT;
  document.getElementById('scriptModal').classList.add('open');
}
function closeModal() { document.getElementById('scriptModal').classList.remove('open'); }
function copyScript() {
  navigator.clipboard.writeText(APPS_SCRIPT).then(()=>toast('âœ“ Script copied!','ok'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE APPS SCRIPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APPS_SCRIPT = `// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIPL Production & Dispatch Tracker â€” Google Apps Script
// â”€â”€ Deploy as Web App â”€â”€
//    Execute as: Me
//    Who has access: Anyone with a Google Account
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Column positions (1-indexed)
const COL = {
  MACHINE:   1,
  PRODUCT:   2,
  THICKNESS: 3,
  GRADE:     4,
  COLOR:     5,
  OPENING:   6,
  // Date pairs start at col 7 (Prod at odd cols, Disp at even cols)
  // TP, TD, CLOSING, SQFT, SQMTR are the last 5 columns
};

const MACHINE_ORDER = ['Apollo','Parijatha PBM+','Rubber Mould','Columbia','Other'];
const MONTH_NAMES   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

// â”€â”€ HTTP HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);
  try {
    const data   = JSON.parse(e.postData.contents);
    const result = processEntry(data);
    return json(result);
  } catch(err) {
    return json({status:'error', message: err.toString()});
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  return json({status:'ok', app:'HIPL Tracker', version:'2.0'});
}

function json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

// â”€â”€ MAIN LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processEntry(data) {
  const ss   = SpreadsheetApp.getActiveSpreadsheet();
  const date = new Date(data.date);

  // Get or create monthly sheet
  const sheetName = MONTH_NAMES[date.getMonth()] + '-' + String(date.getFullYear()).slice(2);
  let sheet = ss.getSheetByName(sheetName);

  if (!sheet) {
    sheet = createMonthlySheet(ss, sheetName, date);
  }

  // Ensure date column exists
  const dateCols = getOrCreateDateColumn(sheet, date);
  const prodCol  = dateCols.prod;
  const dispCol  = dateCols.disp;

  // Find or create data row
  const rowIdx = findRow(sheet, data);

  if (rowIdx > 0) {
    // Row exists â€” overwrite prod/disp for this date (as per spec)
    if (data.production > 0) sheet.getRange(rowIdx, prodCol).setValue(data.production);
    if (data.dispatch   > 0) sheet.getRange(rowIdx, dispCol).setValue(data.dispatch);
    recalcTotals(sheet, rowIdx);
    return {status:'updated', row:rowIdx, sheet:sheetName};
  } else {
    // New row â€” insert in sorted position
    const insertAt = findInsertRow(sheet, data);
    sheet.insertRowBefore(insertAt);

    sheet.getRange(insertAt, COL.MACHINE).setValue(data.machine);
    sheet.getRange(insertAt, COL.PRODUCT).setValue(data.product);
    sheet.getRange(insertAt, COL.THICKNESS).setValue(data.thickness || '');
    sheet.getRange(insertAt, COL.GRADE).setValue(data.grade || '');
    sheet.getRange(insertAt, COL.COLOR).setValue(data.color || '');
    sheet.getRange(insertAt, COL.OPENING).setValue(0);

    sheet.getRange(insertAt, prodCol).setValue(data.production || 0);
    sheet.getRange(insertAt, dispCol).setValue(data.dispatch   || 0);

    // Re-get date col index in case insert shifted things â€” re-fetch
    recalcTotals(sheet, insertAt);
    return {status:'created', row:insertAt, sheet:sheetName};
  }
}

// â”€â”€ ROW MATCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findRow(sheet, data) {
  const last = sheet.getLastRow();
  if (last < 3) return -1;

  const vals = sheet.getRange(3, 1, last - 2, 5).getValues();
  for (let i = 0; i < vals.length; i++) {
    if (
      norm(vals[i][0]) === norm(data.machine)    &&
      norm(vals[i][1]) === norm(data.product)    &&
      norm(vals[i][2]) === norm(data.thickness)  &&
      norm(vals[i][3]) === norm(data.grade||'')  &&
      norm(vals[i][4]) === norm(data.color||'')
    ) return i + 3;
  }
  return -1;
}

function norm(s) { return String(s||'').trim().toLowerCase(); }

// â”€â”€ INSERT POSITION (sorted by Machine order, then Product alpha) â”€
function findInsertRow(sheet, data) {
  const last = sheet.getLastRow();
  if (last < 3) return 3;

  const vals = sheet.getRange(3, 1, last - 2, 2).getValues();
  const mi   = machineIdx(data.machine);

  for (let i = 0; i < vals.length; i++) {
    const rm = machineIdx(String(vals[i][0]));
    if (rm > mi) return i + 3;
    if (rm === mi && norm(vals[i][1]) > norm(data.product)) return i + 3;
  }
  return last + 1;
}

function machineIdx(m) {
  const idx = MACHINE_ORDER.indexOf(m);
  return idx === -1 ? 99 : idx;
}

// â”€â”€ DATE COLUMNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getOrCreateDateColumn(sheet, date) {
  const lastCol = sheet.getLastColumn();
  if (lastCol < 1) return setupNewDateCol(sheet, date);

  // Row 1 has date values in date-pair columns starting at col 7
  const row1 = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  const tgt  = date.toDateString();

  for (let c = 7; c <= lastCol; c += 2) {
    const cell = row1[c - 1];
    if (cell instanceof Date && cell.toDateString() === tgt) {
      return {prod: c, disp: c + 1};
    }
  }
  return setupNewDateCol(sheet, date);
}

function setupNewDateCol(sheet, date) {
  // Find the last Prod column (date columns), insert before totals (last 5 cols)
  const lastCol = sheet.getLastColumn();
  // Totals are last 5 cols: TP, TD, Closing, Sq.Ft, Sq.Mtr
  const TOTAL_COLS = 5;
  const insertAt   = lastCol - TOTAL_COLS + 1;

  sheet.insertColumnsBefore(insertAt, 2);

  // Set date header spanning Prod+Disp
  sheet.getRange(1, insertAt).setValue(date);
  sheet.getRange(1, insertAt).setNumberFormat('dd-mmm-yy');
  sheet.getRange(1, insertAt, 1, 2).merge();
  sheet.getRange(1, insertAt).setHorizontalAlignment('center');

  sheet.getRange(2, insertAt).setValue('Prod');
  sheet.getRange(2, insertAt + 1).setValue('Disp');

  // Style header cells
  const hdrFmt = {
    background: '#2D3748', fontColor: '#F5A623',
    bold: true, fontSize: 10, halign: 'center'
  };
  styleCell(sheet.getRange(1, insertAt), hdrFmt);
  styleCell(sheet.getRange(2, insertAt),   {background:'#2D3748', fontColor:'#68D391', bold:true, halign:'center'});
  styleCell(sheet.getRange(2, insertAt+1), {background:'#2D3748', fontColor:'#FC8181', bold:true, halign:'center'});

  return {prod: insertAt, disp: insertAt + 1};
}

function styleCell(range, opts) {
  if (opts.background) range.setBackground(opts.background);
  const font = SpreadsheetApp.newTextStyle();
  if (opts.fontColor) font.setForegroundColor(opts.fontColor);
  if (opts.bold)      font.setBold(true);
  if (opts.fontSize)  font.setFontSize(opts.fontSize);
  range.setTextStyle(font.build());
  if (opts.halign)    range.setHorizontalAlignment(opts.halign);
}

// â”€â”€ RECALC TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalcTotals(sheet, rowIdx) {
  const lastCol    = sheet.getLastColumn();
  const TOTAL_COLS = 5; // TP, TD, Closing, Sq.Ft, Sq.Mtr
  const firstDate  = 7; // date pairs start here

  // Sum all prod cols and disp cols
  let tp = 0, td = 0;
  const rowVals = sheet.getRange(rowIdx, firstDate, 1, lastCol - firstDate - TOTAL_COLS + 1).getValues()[0];

  for (let i = 0; i < rowVals.length; i += 2) {
    tp += Number(rowVals[i])   || 0;
    td += Number(rowVals[i+1]) || 0;
  }

  const opening  = Number(sheet.getRange(rowIdx, COL.OPENING).getValue()) || 0;
  const closing  = opening + tp - td;

  const tpCol      = lastCol - TOTAL_COLS + 1;
  const tdCol      = tpCol + 1;
  const closingCol = tpCol + 2;
  const sqftCol    = tpCol + 3;
  const sqmCol     = tpCol + 4;

  sheet.getRange(rowIdx, tpCol).setValue(tp);
  sheet.getRange(rowIdx, tdCol).setValue(td);
  sheet.getRange(rowIdx, closingCol).setValue(closing);

  // Sq ft / Sq mtr â€” read factor from a named range or compute from closing stock
  // We store sqftFactor in a helper sheet if available
  // For now, Sq.Ft. and Sq.Mtr. are left to be set manually or via lookup
  // (Factor data not stored in sheet â€” handled client-side in the app)
}

// â”€â”€ CREATE MONTHLY SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createMonthlySheet(ss, sheetName, date) {
  // Insert at position 0 (leftmost)
  const newSheet = ss.insertSheet(sheetName, 0);

  // Try to copy Opening Stock from previous month's Closing Stock
  const prevMonthName = getPrevMonthName(date);
  const prevSheet     = ss.getSheetByName(prevMonthName);

  if (prevSheet) {
    copyFromPreviousMonth(newSheet, prevSheet);
  } else {
    setupBlankSheetHeaders(newSheet);
  }

  return newSheet;
}

function getPrevMonthName(date) {
  const d = new Date(date.getFullYear(), date.getMonth() - 1, 1);
  return MONTH_NAMES[d.getMonth()] + '-' + String(d.getFullYear()).slice(2);
}

function copyFromPreviousMonth(newSheet, prevSheet) {
  const prevLast   = prevSheet.getLastRow();
  const prevLastCol = prevSheet.getLastColumn();
  if (prevLast < 3) { setupBlankSheetHeaders(newSheet); return; }

  // Setup headers on new sheet
  setupBlankSheetHeaders(newSheet);

  // Read all data rows from previous sheet (row 3 onwards)
  const TOTAL_COLS  = 5;
  const dataRows    = prevSheet.getRange(3, 1, prevLast - 2, Math.min(6, prevLastCol)).getValues();
  const closingCol  = prevLastCol - TOTAL_COLS + 3; // TP, TD, Closing...

  // Get closing stock column from previous sheet
  let closingVals = [];
  if (closingCol > 0 && closingCol <= prevLastCol) {
    closingVals = prevSheet.getRange(3, closingCol, prevLast - 2, 1).getValues().map(r => r[0]);
  }

  // Write all rows to new sheet
  for (let i = 0; i < dataRows.length; i++) {
    const r      = dataRows[i];
    const rowNum = i + 3;

    newSheet.getRange(rowNum, COL.MACHINE).setValue(r[0]   || '');
    newSheet.getRange(rowNum, COL.PRODUCT).setValue(r[1]   || '');
    newSheet.getRange(rowNum, COL.THICKNESS).setValue(r[2] || '');
    newSheet.getRange(rowNum, COL.GRADE).setValue(r[3]     || '');
    newSheet.getRange(rowNum, COL.COLOR).setValue(r[4]     || '');

    const opening = closingVals.length > i ? (Number(closingVals[i]) || 0) : 0;
    newSheet.getRange(rowNum, COL.OPENING).setValue(opening);
  }

  // Format data area
  if (dataRows.length > 0) {
    applyDataFormatting(newSheet, 3, dataRows.length);
  }
}

function setupBlankSheetHeaders(sheet) {
  // Row 1: Title / Date headers
  const headers2 = ['Machine Name','Product','Thickness','Grade','Colour','Opening','TP','TD','Closing','Sq. Ft.','Sq. Mtr.'];

  // Write row 2 headers for fixed cols
  headers2.slice(0,6).forEach((h,i) => {
    const cell = sheet.getRange(2, i+1);
    cell.setValue(h);
    styleCell(cell, {background:'#1A2332', fontColor:'#F5A623', bold:true, halign:'center'});
  });

  // Totals headers at end
  const totalHeaders = ['TP','TD','Closing','Sq. Ft.','Sq. Mtr.'];
  totalHeaders.forEach((h,i) => {
    const cell = sheet.getRange(2, 7 + i);
    cell.setValue(h);
    styleCell(cell, {background:'#1A2332', fontColor:'#F5A623', bold:true, halign:'center'});
  });

  // Column widths
  sheet.setColumnWidth(1, 140); // Machine
  sheet.setColumnWidth(2, 140); // Product
  sheet.setColumnWidth(3, 90);  // Thickness
  sheet.setColumnWidth(4, 70);  // Grade
  sheet.setColumnWidth(5, 90);  // Colour
  sheet.setColumnWidth(6, 80);  // Opening

  // Freeze first 6 columns and 2 header rows
  sheet.setFrozenRows(2);
  sheet.setFrozenColumns(6);
}

function applyDataFormatting(sheet, startRow, count) {
  // Alternate row shading for readability
  for (let i = 0; i < count; i++) {
    const row = startRow + i;
    const bg  = i % 2 === 0 ? '#1E2A3A' : '#243044';
    sheet.getRange(row, 1, 1, sheet.getLastColumn()).setBackground(bg);
  }
}`;
</script>
</body>
</html>
