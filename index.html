<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#F8F7F4"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="description" content="Helix Industries Production & Dispatch Tracker"/>
  <link rel="manifest" href="manifest.json"/>
  <title>HIPL Â· Production & Dispatch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold:#E8991C; --gold-light:#F5B842; --gold-pale:#FEF3DC;
      --gold-border:rgba(232,153,28,0.25);
      --ink:#1C1C1E; --ink-mid:#4A4A52; --ink-dim:#8E8E96; --ink-faint:#C4C4CC;
      --bg:#F8F7F4; --bg-card:#FFFFFF; --bg-warm:#FAF9F6;
      --border:rgba(28,28,30,0.09); --border-md:rgba(28,28,30,0.14);
      --green:#2F9E5E; --green-pale:#EBF8F2;
      --red:#D03030; --red-pale:#FEF0F0;
      --shadow-sm:0 1px 3px rgba(0,0,0,0.06),0 1px 2px rgba(0,0,0,0.04);
      --shadow-card:0 0 0 1px var(--border),0 2px 8px rgba(0,0,0,0.05);
      --r:12px; --r-sm:8px;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
      background:radial-gradient(ellipse 70% 40% at 50% -10%,rgba(232,153,28,0.06) 0%,transparent 70%),
      radial-gradient(ellipse 50% 30% at 100% 100%,rgba(232,153,28,0.04) 0%,transparent 60%)}

    /* HEADER */
    .hdr{position:sticky;top:0;z-index:200;background:rgba(248,247,244,0.94);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
    .hdr-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:66px}
    .logo{display:flex;align-items:center;gap:14px}
    .helix-svg{width:44px;height:44px;flex-shrink:0}
    .logo-words h1{font-family:'DM Serif Display',serif;font-size:17px;font-weight:400;letter-spacing:0.02em;color:var(--ink);line-height:1.1}
    .logo-words h1 span{color:var(--gold)}
    .logo-words p{font-size:10px;letter-spacing:0.18em;text-transform:uppercase;color:var(--ink-dim);font-weight:500;margin-top:2px}
    .hdr-badge{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--ink-mid);background:var(--bg-warm);border:1px solid var(--border-md);padding:5px 12px;border-radius:20px}

    /* OFFLINE BAR */
    .offline-bar{display:none;align-items:center;justify-content:center;gap:8px;background:#FFF8E8;border-bottom:1px solid rgba(232,153,28,0.3);padding:9px 20px;font-size:13px;font-weight:500;color:#7A5A00}
    .offline-bar.on{display:flex}

    /* MAIN */
    main{max-width:900px;margin:0 auto;padding:32px 24px 80px;position:relative;z-index:1}

    /* PAGE HEAD */
    .pg-head{margin-bottom:28px;padding-bottom:22px;border-bottom:1px solid var(--border)}
    .pg-head-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .pg-head h2{font-family:'DM Serif Display',serif;font-size:34px;font-weight:400;line-height:1.1;color:var(--ink)}
    .pg-head h2 em{font-style:italic;color:var(--gold)}
    .pg-head p{font-size:14px;color:var(--ink-dim);margin-top:6px;line-height:1.5}
    .date-pill{display:flex;align-items:center;gap:8px;background:var(--bg-card);border:1px solid var(--border-md);border-radius:10px;padding:8px 14px;box-shadow:var(--shadow-sm);flex-shrink:0}
    .date-pill label{font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--ink-dim)}
    .date-pill input[type="date"]{border:none;outline:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;color:var(--ink);cursor:pointer}
    .date-pill input[type="date"]::-webkit-calendar-picker-indicator{opacity:0.4;cursor:pointer}

    /* SECTION LABEL */
    .section-label{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .section-label h3{font-size:12px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-dim)}
    .batch-summary{font-size:12px;font-weight:600;color:var(--ink-mid);background:var(--bg-warm);border:1px solid var(--border);padding:4px 10px;border-radius:20px}
    .batch-summary span{color:var(--gold)}

    /* ENTRY CARD */
    .entry-card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow-card);margin-bottom:12px;transition:border-color 0.2s,box-shadow 0.2s;overflow:hidden;animation:cardIn 0.22s ease both}
    @keyframes cardIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .entry-card.valid{border-color:rgba(47,158,94,0.4)}
    .entry-card.has-error{border-color:rgba(208,48,48,0.4)}

    .card-hdr{display:flex;align-items:center;gap:12px;padding:14px 18px;cursor:pointer;user-select:none;transition:background 0.15s}
    .card-hdr:hover{background:rgba(0,0,0,0.015)}

    .card-num{width:26px;height:26px;border-radius:50%;background:var(--gold);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.2s}
    .card-num.ready{background:var(--green)}

    .card-title{font-size:14px;font-weight:600;color:var(--ink)}
    .card-summary{font-size:12px;color:var(--ink-dim);margin-top:1px}

    .card-actions{display:flex;align-items:center;gap:6px;margin-left:auto}
    .card-chevron{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;color:var(--ink-dim);font-size:11px;transition:transform 0.2s,background 0.15s;flex-shrink:0}
    .card-chevron:hover{background:rgba(0,0,0,0.06)}
    .entry-card.collapsed .card-chevron{transform:rotate(-90deg)}

    .btn-remove{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;border:none;cursor:pointer;background:transparent;color:var(--ink-faint);font-size:15px;transition:background 0.15s,color 0.15s}
    .btn-remove:hover{background:var(--red-pale);color:var(--red)}

    .card-body{padding:0 18px 18px;border-top:1px solid var(--border)}
    .entry-card.collapsed .card-body{display:none}

    /* FIELD GRID */
    .field-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:16px}
    .span2{grid-column:span 2}
    .ff{display:flex;flex-direction:column;gap:5px}
    .fl{font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--ink-dim)}
    .req{color:var(--gold)}

    select,input[type="text"],input[type="number"]{width:100%;padding:9px 12px;border:1px solid var(--border-md);border-radius:var(--r-sm);background:var(--bg);font-family:'DM Sans',sans-serif;font-size:14px;color:var(--ink);outline:none;transition:border-color 0.15s,box-shadow 0.15s,background 0.15s;appearance:none;-webkit-appearance:none}
    select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238E8E96' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;cursor:pointer}
    select:focus,input[type="text"]:focus,input[type="number"]:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(232,153,28,0.12);background:var(--bg-card)}
    select:disabled{opacity:0.5;cursor:not-allowed}
    input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none}
    .other-input{display:none;margin-top:6px}
    .other-input.show{display:block}
    .emsg{font-size:11px;color:var(--red);font-weight:500;min-height:14px;display:block}

    /* QUANTITY BOXES */
    .qty-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    .qty-box{border-radius:var(--r-sm);border:1px solid var(--border-md);overflow:hidden}
    .qty-box-hdr{padding:8px 12px;font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase}
    .qty-box.prod .qty-box-hdr{background:var(--green-pale);color:var(--green)}
    .qty-box.disp .qty-box-hdr{background:var(--red-pale);color:var(--red)}
    .qty-box input{border:none;border-top:1px solid var(--border);border-radius:0;font-size:22px;font-weight:600;text-align:center;padding:12px;background:var(--bg-card)}
    .qty-box input:focus{box-shadow:none;background:#FFFDF8}
    .qty-box-hint{padding:4px 12px 8px;font-size:11px;color:var(--ink-dim);text-align:center;background:var(--bg-card)}

    .conv-preview{margin-top:10px;padding:9px 12px;background:var(--gold-pale);border:1px solid var(--gold-border);border-radius:var(--r-sm);font-size:12px;color:#7A5A00;font-weight:500;display:none}
    .conv-preview.show{display:block}

    /* ADD BUTTON */
    .btn-add-entry{width:100%;padding:14px;border:2px dashed var(--border-md);border-radius:var(--r);background:transparent;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;color:var(--ink-dim);display:flex;align-items:center;justify-content:center;gap:8px;transition:border-color 0.2s,color 0.2s,background 0.2s;margin-bottom:24px}
    .btn-add-entry:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-pale)}
    .btn-add-plus{width:22px;height:22px;border-radius:50%;background:rgba(28,28,30,0.08);color:var(--ink-dim);display:flex;align-items:center;justify-content:center;font-size:16px;line-height:1;transition:background 0.2s,color 0.2s}
    .btn-add-entry:hover .btn-add-plus{background:var(--gold);color:#fff}

    /* SETTINGS */
    .settings-wrap{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:24px;box-shadow:var(--shadow-sm)}
    .settings-toggle{display:flex;align-items:center;gap:10px;padding:14px 18px;cursor:pointer;font-size:14px;font-weight:600;color:var(--ink);user-select:none;transition:background 0.15s}
    .settings-toggle:hover{background:var(--bg-warm)}
    .arr{font-size:10px;color:var(--ink-dim);transition:transform 0.2s;flex-shrink:0}
    .settings-toggle.open .arr{transform:rotate(90deg)}
    .settings-panel{display:none;flex-direction:column;gap:14px;padding:18px;border-top:1px solid var(--border);background:var(--bg-warm)}
    .settings-panel.open{display:flex}
    .settings-panel label{font-size:12px;font-weight:600;color:var(--ink-mid);display:block;margin-bottom:5px}
    .settings-note{font-size:12px;color:var(--ink-dim);line-height:1.7;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px}
    .script-link{color:var(--gold);font-weight:600;cursor:pointer;text-decoration:underline;text-underline-offset:3px}
    .btn-save-cfg{align-self:flex-start;padding:9px 18px;background:var(--ink);color:#fff;border:none;border-radius:var(--r-sm);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:background 0.15s}
    .btn-save-cfg:hover{background:#333}

    /* ACTIONS */
    .actions{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:32px}
    .btn-ghost{padding:11px 20px;background:transparent;color:var(--ink-mid);border:1px solid var(--border-md);border-radius:var(--r-sm);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.15s}
    .btn-ghost:hover{background:var(--bg-warm)}
    .btn-primary{padding:11px 28px;background:var(--gold);color:#fff;border:none;border-radius:var(--r-sm);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(232,153,28,0.35);transition:background 0.15s,box-shadow 0.15s,transform 0.1s;display:flex;align-items:center;gap:8px}
    .btn-primary:hover{background:var(--gold-light);box-shadow:0 4px 14px rgba(232,153,28,0.4)}
    .btn-primary:active{transform:scale(0.98)}
    .btn-primary:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.35);border-top-color:#fff;animation:spin 0.7s linear infinite;display:inline-block}

    /* LOG */
    .log-section{margin-top:8px}
    .log-title{font-size:12px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink-dim);margin-bottom:12px}
    .log-empty{text-align:center;padding:32px;font-size:14px;color:var(--ink-faint);background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r)}
    .log-batch{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;overflow:hidden;box-shadow:var(--shadow-sm)}
    .log-batch-hdr{display:flex;align-items:center;gap:10px;padding:11px 16px;cursor:pointer;font-size:13px;background:var(--bg-warm);border-bottom:1px solid var(--border);transition:background 0.15s}
    .log-batch-hdr:hover{background:#F0EFE9}
    .log-batch-count{background:var(--gold-pale);color:var(--gold);border:1px solid var(--gold-border);font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
    .log-batch-date{font-weight:600;color:var(--ink)}
    .log-batch-time{color:var(--ink-dim);font-size:12px;margin-left:auto}
    .log-row{display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:13px}
    .log-row:last-child{border-bottom:none}
    .log-machine{font-size:10px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:#fff;background:var(--ink);padding:3px 8px;border-radius:4px;flex-shrink:0}
    .log-product{font-weight:600;color:var(--ink)}
    .log-meta{color:var(--ink-dim);font-size:12px}
    .log-qty{margin-left:auto;display:flex;gap:10px;flex-shrink:0}
    .log-prod{font-weight:600;color:var(--green);font-size:12px}
    .log-disp{font-weight:600;color:var(--red);font-size:12px}

    /* MODAL */
    .modal-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(28,28,30,0.5);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:20px}
    .modal-overlay.open{display:flex}
    .modal-box{background:var(--bg-card);border-radius:16px;width:100%;max-width:640px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 60px rgba(0,0,0,0.2);overflow:hidden}
    .modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border)}
    .modal-hdr h3{font-size:16px;font-weight:700;color:var(--ink)}
    .modal-close{width:30px;height:30px;border:none;cursor:pointer;background:var(--bg);border-radius:6px;font-size:14px;color:var(--ink-mid);display:flex;align-items:center;justify-content:center;transition:background 0.15s}
    .modal-close:hover{background:var(--red-pale);color:var(--red)}
    .modal-body{padding:20px 22px;overflow-y:auto;flex:1}
    .modal-note{font-size:13px;color:var(--ink-dim);margin-bottom:12px;line-height:1.6}
    .modal-steps{font-size:12px;color:#7A5A00;background:var(--gold-pale);border:1px solid var(--gold-border);border-radius:var(--r-sm);padding:10px 14px;margin-bottom:14px;line-height:1.7}
    pre#scriptPre{background:var(--ink);color:#C9D1D9;border-radius:var(--r-sm);padding:16px;font-size:11px;line-height:1.6;overflow-x:auto;white-space:pre-wrap;max-height:340px;overflow-y:auto;font-family:'Courier New',monospace}
    .btn-copy{margin-top:14px;padding:10px 20px;background:var(--ink);color:#fff;border:none;border-radius:var(--r-sm);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:background 0.15s}
    .btn-copy:hover{background:#333}

    /* TOASTS */
    .toast-wrap{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:999;display:flex;flex-direction:column;gap:8px;align-items:center;pointer-events:none;width:min(380px,calc(100vw - 40px))}
    .toast{width:100%;padding:12px 16px;border-radius:10px;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,0.12);animation:toastIn 0.22s ease both;pointer-events:auto}
    @keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes toastOut{to{opacity:0;transform:translateY(6px)}}
    .toast.ok{background:var(--ink);color:#fff}
    .toast.err{background:var(--red-pale);color:var(--red);border:1px solid rgba(208,48,48,0.2)}
    .toast.inf{background:var(--gold-pale);color:#7A5A00;border:1px solid var(--gold-border)}
    .t-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .toast.ok .t-dot{background:#68D391}
    .toast.err .t-dot{background:var(--red)}
    .toast.inf .t-dot{background:var(--gold);animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

    @media(max-width:700px){.field-grid{grid-template-columns:1fr 1fr}.span2{grid-column:span 2}.pg-head h2{font-size:26px}.hdr-badge{display:none}}
    @media(max-width:480px){main{padding:20px 16px 80px}.field-grid{grid-template-columns:1fr}.span2{grid-column:1}.hdr-inner{padding:0 16px}}
  </style>
</head>
<body>

<header class="hdr">
  <div class="hdr-inner">
    <div class="logo">
      <svg class="helix-svg" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="44" height="44" rx="7" fill="#FFFFFF"/>
        <rect x="2" y="2" width="18" height="18" rx="2.5" fill="#2C2C2E"/>
        <rect x="24" y="2" width="18" height="18" rx="2.5" fill="#E8991C"/>
        <polygon points="32,20 42,10 42,20" fill="#FFFFFF"/>
        <rect x="2" y="24" width="18" height="18" rx="2.5" fill="#E8991C"/>
        <rect x="24" y="24" width="18" height="18" rx="2.5" fill="#2C2C2E"/>
        <rect x="0.5" y="0.5" width="43" height="43" rx="7.5" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>
      </svg>
      <div class="logo-words">
        <h1>Helix <span>Industries</span></h1>
        <p>Quality Redefined</p>
      </div>
    </div>
    <div class="hdr-badge">Prod &amp; Dispatch</div>
  </div>
</header>

<div class="offline-bar" id="offlineBar">
  <span>âš¡</span> You're offline â€” entries will queue and sync automatically.
</div>

<main>
  <div class="pg-head">
    <div class="pg-head-top">
      <div>
        <h2>Production &amp; <em>Dispatch</em></h2>
        <p>Add multiple entries and submit them all at once to Google Sheets.</p>
      </div>
      <div class="date-pill">
        <label>Date</label>
        <input type="date" id="entryDate"/>
      </div>
    </div>
  </div>

  <div class="section-label">
    <h3>Entries</h3>
    <div class="batch-summary" id="batchSummary">0 ready</div>
  </div>

  <div id="entryCards"></div>

  <button class="btn-add-entry" onclick="addEntry()">
    <span class="btn-add-plus">+</span>
    Add Another Entry
  </button>

  <div class="settings-wrap">
    <div class="settings-toggle" id="settingsToggle" onclick="toggleSettings()">
      <span class="arr">â–¶</span>
      <span>âš™ Google Sheets Integration</span>
      <span id="cfgStatus" style="margin-left:auto;font-size:11px;"></span>
    </div>
    <div class="settings-panel" id="settingsPanel">
      <div>
        <label>Google Apps Script Web App URL</label>
        <input type="text" id="iScriptUrl" placeholder="https://script.google.com/macros/s/â€¦/exec"/>
      </div>
      <div class="settings-note">
        <strong>How to connect:</strong><br>
        1. Open your Google Sheet â†’ Extensions â†’ Apps Script<br>
        2. Paste the provided script â†’ Save (ðŸ’¾)<br>
        3. Deploy â†’ New Deployment â†’ Web App<br>
        &nbsp;&nbsp;&nbsp;Â· Execute as: <strong>Me</strong><br>
        &nbsp;&nbsp;&nbsp;Â· Who has access: <strong>Anyone with Google Account</strong><br>
        4. Copy the deployment URL and paste above<br><br>
        <span class="script-link" onclick="openModal()">ðŸ“‹ View &amp; copy the Google Apps Script â†’</span>
      </div>
      <button class="btn-save-cfg" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>

  <div class="actions">
    <button class="btn-ghost" onclick="clearAll()">â†º Clear All</button>
    <button class="btn-primary" id="btnSubmit" onclick="submitAll()">Submit All Entries</button>
  </div>

  <div class="log-section">
    <div class="log-title">Recent Submissions</div>
    <div id="logList"></div>
  </div>
</main>

<div class="modal-overlay" id="scriptModal">
  <div class="modal-box">
    <div class="modal-hdr">
      <h3>Google Apps Script â€” Setup Code</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="modal-note">Copy this entire script into your Apps Script editor, then deploy as a Web App.</p>
      <div class="modal-steps">
        <strong>Extensions â†’ Apps Script â†’ Paste â†’ Save (ðŸ’¾) â†’ Deploy â†’ New Deployment â†’ Web App</strong><br>
        Execute as: <strong>Me</strong> &nbsp;|&nbsp; Who has access: <strong>Anyone with Google Account</strong>
      </div>
      <pre id="scriptPre"></pre>
      <button class="btn-copy" onclick="copyScript()">ðŸ“‹ Copy Script to Clipboard</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
'use strict';

/* â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const MACHINE_PRODUCTS = {
  'Apollo':['Hexagon','8x8 Quad','8x4','Kerbstone Round','Kerbstone Chamfered','Kerbstone Bullnose'],
  'Parijatha PBM+':['Hexagon','Zigzag','I-Shape','8x4','Tricon','S-Paver'],
  'Rubber Mould':['Jumbo','Zigzag','Euphrates','River Quad','3D Hexa','Cobble','8x4','4x4','Cobble 4.5"','X-Block','Cover Block Big','Cover Block Small','36 Striker','Cross Strip','Matrix','Riveira','BB Bali','BB Aruba','BB Maui','BB Maldives','BB Ibiza','BB Barbados','Cool Roof Tile','Drain Channel'],
  'Columbia':[],
  'Other':[]
};

const CONV = {
  'Apollo|Hexagon':2.50,'Apollo|8x8 Quad':2.25,'Apollo|8x4':4.50,
  'Apollo|Kerbstone Round':1.00,'Apollo|Kerbstone Chamfered':1.00,'Apollo|Kerbstone Bullnose':1.00,
  'Parijatha PBM+|Hexagon':2.50,'Parijatha PBM+|Zigzag':3.50,'Parijatha PBM+|I-Shape':3.25,
  'Parijatha PBM+|8x4':4.50,'Parijatha PBM+|Tricon':2.90,'Parijatha PBM+|S-Paver':4.50,
  'Rubber Mould|Jumbo':1.80,'Rubber Mould|Zigzag':2.80,'Rubber Mould|Euphrates':2.50,
  'Rubber Mould|River Quad':2.25,'Rubber Mould|3D Hexa':2.50,'Rubber Mould|Cobble':2.25,
  'Rubber Mould|8x4':4.50,'Rubber Mould|4x4':9.00,'Rubber Mould|Cobble 4.5"':7.11,
  'Rubber Mould|X-Block':1.44,'Rubber Mould|36 Striker':1.00,'Rubber Mould|Cross Strip':1.00,
  'Rubber Mould|Matrix':1.00,'Rubber Mould|BB Bali':2.25,'Rubber Mould|BB Aruba':2.25,
  'Rubber Mould|BB Maui':2.25,'Rubber Mould|BB Maldives':2.25,'Rubber Mould|BB Ibiza':2.25,
  'Rubber Mould|BB Barbados':2.25,'Rubber Mould|Cool Roof Tile':1.00,'Rubber Mould|Drain Channel':1.00
};

const SQM = 0.092903;

/* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let entries = [];
let nextId  = 0;
const $ = id => document.getElementById(id);

/* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {
  const t = new Date();
  $('entryDate').value = t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
  $('iScriptUrl').value = localStorage.getItem('hipl_url') || '';
  updateCfgStatus();
  addEntry();
  renderLog();

  const ob = $('offlineBar');
  window.addEventListener('offline', () => ob.classList.add('on'));
  window.addEventListener('online',  () => { ob.classList.remove('on'); syncQueue(); });
  if (!navigator.onLine) ob.classList.add('on');

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', e => { if (e.data && e.data.type === 'SYNC_NOW') syncQueue(); });
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
});

/* â”€â”€ CARD MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addEntry() {
  const id = nextId++;
  entries.push({ id });
  entries.forEach(e => { if (e.id !== id) collapseCard(e.id); });

  const wrap = $('entryCards');
  const el   = document.createElement('div');
  el.className = 'entry-card';
  el.id        = 'card-' + id;
  el.innerHTML = buildCardHTML(id);
  wrap.appendChild(el);

  setTimeout(() => el.scrollIntoView({ behavior:'smooth', block:'nearest' }), 60);
  refreshBatchBar();
}

function buildCardHTML(id) {
  const num = entries.findIndex(e => e.id === id) + 1;
  const removeBtn = entries.length > 1
    ? '<button class="btn-remove" onclick="removeEntry(' + id + ')" title="Remove">&#x2715;</button>' : '';
  return (
    '<div class="card-hdr" onclick="toggleCollapse(' + id + ')">' +
      '<div class="card-num" id="card-num-' + id + '">' + num + '</div>' +
      '<div style="flex:1">' +
        '<div class="card-title" id="card-title-' + id + '">Entry ' + num + '</div>' +
        '<div class="card-summary" id="card-summary-' + id + '">Fill in the fields below</div>' +
      '</div>' +
      '<div class="card-actions" onclick="event.stopPropagation()">' + removeBtn + '</div>' +
      '<div class="card-chevron">&#9660;</div>' +
    '</div>' +
    '<div class="card-body">' +
      '<div class="field-grid">' +

        '<div class="ff">' +
          '<label class="fl">Machine <span class="req">*</span></label>' +
          '<select id="sMachine-' + id + '" onchange="onMachine(' + id + ')">' +
            '<option value="">Select Machine</option>' +
            '<option value="Apollo">Apollo</option>' +
            '<option value="Parijatha PBM+">Parijatha PBM+</option>' +
            '<option value="Rubber Mould">Rubber Mould</option>' +
            '<option value="Columbia">Columbia</option>' +
            '<option value="Other">Other</option>' +
          '</select>' +
          '<span class="emsg" id="eMachine-' + id + '"></span>' +
        '</div>' +

        '<div class="ff">' +
          '<label class="fl">Product <span class="req">*</span></label>' +
          '<select id="sProduct-' + id + '" disabled onchange="onProduct(' + id + ')">' +
            '<option value="">Select Machine First</option>' +
          '</select>' +
          '<span class="emsg" id="eProduct-' + id + '"></span>' +
        '</div>' +

        '<div class="ff">' +
          '<label class="fl">Thickness <span class="req">*</span></label>' +
          '<select id="sThickness-' + id + '" onchange="onThickness(' + id + ')">' +
            '<option value="">Select Thickness</option>' +
            '<option value="20 MM">20 MM</option>' +
            '<option value="25 MM">25 MM</option>' +
            '<option value="30 MM">30 MM</option>' +
            '<option value="60 MM">60 MM</option>' +
            '<option value="75 MM">75 MM</option>' +
            '<option value="80 MM">80 MM</option>' +
            '<option value="100 MM">100 MM</option>' +
            '<option value="150 MM">150 MM</option>' +
            '<option value="Other">Otherâ€¦</option>' +
          '</select>' +
          '<input type="text" id="iThicknessOther-' + id + '" class="other-input" placeholder="Enter thicknessâ€¦"/>' +
          '<span class="emsg" id="eThickness-' + id + '"></span>' +
        '</div>' +

        '<div class="ff">' +
          '<label class="fl">Grade</label>' +
          '<select id="sGrade-' + id + '">' +
            '<option value="">None / N/A</option>' +
            '<option value="M-7.5">M-7.5</option>' +
            '<option value="M-12.5">M-12.5</option>' +
            '<option value="M-25">M-25</option>' +
            '<option value="M-30">M-30</option>' +
            '<option value="M-35">M-35</option>' +
            '<option value="M-40">M-40</option>' +
            '<option value="M-50">M-50</option>' +
          '</select>' +
        '</div>' +

        '<div class="ff span2">' +
          '<label class="fl">Color</label>' +
          '<select id="sColor-' + id + '" onchange="onColor(' + id + ')">' +
            '<option value="">Select Color</option>' +
            '<option value="Grey">Grey</option>' +
            '<option value="Dark Grey">Dark Grey</option>' +
            '<option value="Red">Red</option>' +
            '<option value="Yellow">Yellow</option>' +
            '<option value="Chocolate">Chocolate</option>' +
            '<option value="Orange">Orange</option>' +
            '<option value="White">White</option>' +
            '<option value="Blue">Blue</option>' +
            '<option value="Green">Green</option>' +
            '<option value="Other">Otherâ€¦</option>' +
          '</select>' +
          '<input type="text" id="iColorOther-' + id + '" class="other-input" placeholder="Enter color nameâ€¦"/>' +
        '</div>' +

      '</div>' +

      '<div class="qty-grid">' +
        '<div class="qty-box prod">' +
          '<div class="qty-box-hdr">&#x2191; Production (pcs)</div>' +
          '<input type="number" id="iProd-' + id + '" placeholder="0" min="0" oninput="onQty(' + id + ')"/>' +
          '<div class="qty-box-hint">Manufactured today</div>' +
        '</div>' +
        '<div class="qty-box disp">' +
          '<div class="qty-box-hdr">&#x2193; Dispatch (pcs)</div>' +
          '<input type="number" id="iDisp-' + id + '" placeholder="0" min="0" oninput="onQty(' + id + ')"/>' +
          '<div class="qty-box-hint">Dispatched today</div>' +
        '</div>' +
      '</div>' +

      '<div class="conv-preview" id="convPreview-' + id + '"></div>' +
    '</div>'
  );
}

function removeEntry(id) {
  if (entries.length <= 1) return;
  entries = entries.filter(e => e.id !== id);
  const el = $('card-' + id);
  if (el) el.remove();
  renumberCards();
  refreshBatchBar();
}

function renumberCards() {
  entries.forEach((e, i) => {
    const num = $('card-num-' + e.id);
    const ttl = $('card-title-' + e.id);
    if (num) num.textContent = i + 1;
    if (ttl && ttl.textContent.startsWith('Entry ')) ttl.textContent = 'Entry ' + (i + 1);
  });
}

function collapseCard(id)  { const el = $('card-' + id); if (el) el.classList.add('collapsed'); }
function expandCard(id)    { const el = $('card-' + id); if (el) el.classList.remove('collapsed'); }
function toggleCollapse(id){ const el = $('card-' + id); if (el) el.classList.toggle('collapsed'); }

/* â”€â”€ FIELD EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onMachine(id) {
  const machine  = $('sMachine-' + id).value;
  const products = MACHINE_PRODUCTS[machine] || [];
  const sel      = $('sProduct-' + id);
  sel.innerHTML  = products.length
    ? '<option value="">Select Product</option>' + products.map(function(p){ return '<option value="' + p + '">' + p + '</option>'; }).join('')
    : '<option value="">No products defined</option>';
  sel.disabled = !products.length;
  $('eProduct-' + id).textContent = '';
  updateConversion(id);
  updateCardState(id);
}

function onProduct(id)   { $('eProduct-' + id).textContent = ''; updateConversion(id); updateCardState(id); }

function onThickness(id) {
  const v = $('sThickness-' + id).value;
  $('iThicknessOther-' + id).classList.toggle('show', v === 'Other');
  $('eThickness-' + id).textContent = '';
  updateCardState(id);
}

function onColor(id) {
  const v = $('sColor-' + id).value;
  $('iColorOther-' + id).classList.toggle('show', v === 'Other');
}

function onQty(id) { updateConversion(id); updateCardState(id); }

function updateConversion(id) {
  const machine = ($('sMachine-' + id) || {}).value || '';
  const product = ($('sProduct-' + id) || {}).value || '';
  const prod    = parseFloat(($('iProd-' + id) || {}).value) || 0;
  const disp    = parseFloat(($('iDisp-' + id) || {}).value) || 0;
  const factor  = CONV[machine + '|' + product];
  const box     = $('convPreview-' + id);
  if (!box) return;
  if (factor && (prod || disp)) {
    var parts = [];
    if (prod) parts.push('Prod: ' + (prod/factor).toFixed(1) + ' sq.ft  \u00b7  ' + (prod/factor*SQM).toFixed(2) + ' sq.m');
    if (disp) parts.push('Disp: ' + (disp/factor).toFixed(1) + ' sq.ft  \u00b7  ' + (disp/factor*SQM).toFixed(2) + ' sq.m');
    box.textContent = parts.join('    ');
    box.classList.add('show');
  } else {
    box.classList.remove('show');
  }
}

/* â”€â”€ VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function validateCard(id, showErrors) {
  var ok       = true;
  var machine  = ($('sMachine-'  + id) || {}).value;
  var product  = ($('sProduct-'  + id) || {}).value;
  var thick    = ($('sThickness-'+ id) || {}).value;
  var thickOth = (($('iThicknessOther-' + id) || {}).value || '').trim();

  if (!machine)  { if (showErrors) $('eMachine-'  + id).textContent = 'Machine is required.';   ok = false; }
  else             $('eMachine-'  + id).textContent = '';
  if (!product)  { if (showErrors) $('eProduct-'  + id).textContent = 'Product is required.';   ok = false; }
  else             $('eProduct-'  + id).textContent = '';
  if (!thick)    { if (showErrors) $('eThickness-' + id).textContent = 'Thickness is required.'; ok = false; }
  else if (thick === 'Other' && !thickOth) { if (showErrors) $('eThickness-' + id).textContent = 'Please specify.'; ok = false; }
  else             $('eThickness-' + id).textContent = '';
  return ok;
}

function updateCardState(id) {
  var valid = validateCard(id, false);
  var card  = $('card-' + id);
  var num   = $('card-num-' + id);
  if (!card) return;
  card.classList.toggle('valid', valid);
  if (num) num.classList.toggle('ready', valid);
  updateCollapseSummary(id);
  refreshBatchBar();
}

function updateCollapseSummary(id) {
  var machine  = (($('sMachine-'  + id) || {}).value) || '';
  var product  = (($('sProduct-'  + id) || {}).value) || '';
  var thick    = (($('sThickness-'+ id) || {}).value) || '';
  var prod     = parseFloat((($('iProd-'+ id) || {}).value)) || 0;
  var disp     = parseFloat((($('iDisp-'+ id) || {}).value)) || 0;
  var ttl = $('card-title-'   + id);
  var sum = $('card-summary-' + id);
  if (!ttl || !sum) return;
  if (machine && product) {
    ttl.textContent = machine + ' \u2014 ' + product;
    var parts = [];
    if (thick) parts.push(thick);
    if (prod)  parts.push('\u2191' + prod);
    if (disp)  parts.push('\u2193' + disp);
    sum.textContent = parts.length ? parts.join(' \u00b7 ') : 'Fill in quantities';
  } else {
    var idx = entries.findIndex(function(e){ return e.id === id; });
    ttl.textContent = 'Entry ' + (idx + 1);
    sum.textContent = 'Fill in the fields below';
  }
}

function refreshBatchBar() {
  var ready = entries.filter(function(e){ return validateCard(e.id, false); }).length;
  var bar   = $('batchSummary');
  if (bar) bar.innerHTML = '<span>' + ready + '</span> of ' + entries.length + ' ready';
}

/* â”€â”€ BUILD ENTRY OBJ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildEntryObj(id) {
  var machine   = $('sMachine-'   + id).value;
  var product   = $('sProduct-'   + id).value;
  var thickRaw  = $('sThickness-' + id).value;
  var thickness = thickRaw === 'Other' ? $('iThicknessOther-' + id).value.trim() : thickRaw;
  var colorRaw  = $('sColor-'     + id).value;
  var color     = colorRaw === 'Other' ? $('iColorOther-' + id).value.trim() : colorRaw;
  var prod      = parseFloat($('iProd-' + id).value) || 0;
  var disp      = parseFloat($('iDisp-' + id).value) || 0;
  var factor    = CONV[machine + '|' + product] || null;
  return {
    date:       $('entryDate').value,
    machine: machine, product: product,
    thickness: thickness,
    grade:    $('sGrade-' + id).value,
    color:    color,
    production: prod, dispatch: disp,
    sqftFactor: factor,
    prodSqft:   factor && prod ? +(prod/factor).toFixed(4) : null,
    dispSqft:   factor && disp ? +(disp/factor).toFixed(4) : null,
    prodSqm:    factor && prod ? +(prod/factor*SQM).toFixed(4) : null,
    dispSqm:    factor && disp ? +(disp/factor*SQM).toFixed(4) : null,
    timestamp: new Date().toISOString()
  };
}

/* â”€â”€ SUBMIT ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function submitAll() {
  var allOk = true;
  entries.forEach(function(e) {
    var ok = validateCard(e.id, true);
    if (!ok) { allOk = false; expandCard(e.id); $('card-' + e.id).classList.add('has-error'); }
    else       $('card-' + e.id).classList.remove('has-error');
  });
  if (!allOk) { toast('Please fix the highlighted errors first.', 'err'); return; }

  var hasQty = entries.some(function(e) {
    return (parseFloat(($('iProd-' + e.id) || {}).value)||0) > 0
        || (parseFloat(($('iDisp-' + e.id) || {}).value)||0) > 0;
  });
  if (!hasQty) { toast('Enter at least one Production or Dispatch quantity.', 'err'); return; }

  var batch     = entries.map(function(e){ return buildEntryObj(e.id); });
  var btn       = $('btnSubmit');
  var scriptUrl = localStorage.getItem('hipl_url');

  btn.disabled  = true;
  btn.innerHTML = '<span class="spin"></span> Submitting\u2026';

  saveBatch(batch);

  if (!scriptUrl) {
    toast('Saved locally. Configure Google Sheets to sync.', 'inf');
    finishSubmit(btn); return;
  }
  if (!navigator.onLine) {
    queueOffline(batch);
    toast('Offline \u2014 queued for sync when reconnected.', 'inf');
    finishSubmit(btn); return;
  }

  try {
    await fetch(scriptUrl, {
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({ batch: batch })
    });
    toast('\u2713 ' + batch.length + (batch.length === 1 ? ' entry' : ' entries') + ' submitted to Google Sheets!', 'ok');
  } catch(err) {
    console.error('Submit error:', err.message);
    queueOffline(batch);
    toast('No internet \u2014 saved locally, will sync when reconnected.', 'inf');
  }
  finishSubmit(btn);
}

function finishSubmit(btn) {
  btn.disabled  = false;
  btn.innerHTML = 'Submit All Entries';
  renderLog();
  entries = []; nextId = 0;
  $('entryCards').innerHTML = '';
  addEntry(); refreshBatchBar();
}

function clearAll() {
  entries = []; nextId = 0;
  $('entryCards').innerHTML = '';
  addEntry(); refreshBatchBar();
}

/* â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveBatch(batch) {
  var stored = JSON.parse(localStorage.getItem('hipl_batches') || '[]');
  stored.unshift({ batch: batch, ts: new Date().toISOString() });
  if (stored.length > 20) stored.splice(20);
  localStorage.setItem('hipl_batches', JSON.stringify(stored));
}

function queueOffline(batch) {
  var q = JSON.parse(localStorage.getItem('hipl_queue') || '[]');
  q.push({ batch: batch, ts: new Date().toISOString() });
  localStorage.setItem('hipl_queue', JSON.stringify(q));
}

async function syncQueue() {
  var url = localStorage.getItem('hipl_url');
  if (!url) return;
  var q = JSON.parse(localStorage.getItem('hipl_queue') || '[]');
  if (!q.length) return;
  toast('Syncing ' + q.length + ' queued item' + (q.length > 1 ? 's' : '') + '\u2026', 'inf');
  var fail = [];
  for (var i = 0; i < q.length; i++) {
    try {
      await fetch(url, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ batch: q[i].batch }) });
    } catch(e) { fail.push(q[i]); }
  }
  localStorage.setItem('hipl_queue', JSON.stringify(fail));
  var synced = q.length - fail.length;
  if (synced > 0) toast('\u2713 ' + synced + ' item' + (synced > 1 ? 's' : '') + ' synced!', 'ok');
}

/* â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderLog() {
  var list    = $('logList');
  var batches = JSON.parse(localStorage.getItem('hipl_batches') || '[]');
  if (!batches.length) {
    list.innerHTML = '<div class="log-empty">No submissions yet \u2014 entries will appear here after submitting.</div>';
    return;
  }
  list.innerHTML = batches.slice(0, 8).map(function(b, i) {
    var dt  = new Date(b.ts);
    var day = dt.toLocaleDateString('en-IN', { weekday:'short', day:'numeric', month:'short' });
    var tim = dt.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
    var rows = (b.batch || []).map(function(e) {
      return '<div class="log-row">' +
        '<span class="log-machine">' + (e.machine || '\u2014') + '</span>' +
        '<div>' +
          '<div class="log-product">' + (e.product || '\u2014') + '</div>' +
          '<div class="log-meta">' + ([e.thickness, e.grade, e.color].filter(Boolean).join(' \u00b7 ') || '\u2014') + '</div>' +
        '</div>' +
        '<div class="log-qty">' +
          (e.production ? '<span class="log-prod">\u2191' + e.production + '</span>' : '') +
          (e.dispatch   ? '<span class="log-disp">\u2193' + e.dispatch   + '</span>' : '') +
        '</div>' +
      '</div>';
    }).join('');
    var entryWord = b.batch.length === 1 ? 'entry' : 'entries';
    return '<div class="log-batch">' +
      '<div class="log-batch-hdr" onclick="var d=this.nextElementSibling;d.style.display=d.style.display===\'none\'?\'block\':\'none\'">' +
        '<span class="log-batch-count">' + b.batch.length + ' ' + entryWord + '</span>' +
        '<span class="log-batch-date">' + (b.batch[0] && b.batch[0].date ? b.batch[0].date : day) + '</span>' +
        '<span class="log-batch-time">' + tim + '</span>' +
      '</div>' +
      '<div style="display:' + (i === 0 ? 'block' : 'none') + '">' + rows + '</div>' +
    '</div>';
  }).join('');
}

/* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleSettings() {
  $('settingsToggle').classList.toggle('open');
  $('settingsPanel').classList.toggle('open');
}
function saveSettings() {
  var url = $('iScriptUrl').value.trim();
  localStorage.setItem('hipl_url', url);
  updateCfgStatus();
  toast('Settings saved!', 'ok');
}
function updateCfgStatus() {
  var el  = $('cfgStatus');
  var url = localStorage.getItem('hipl_url') || '';
  el.textContent = url ? '\uD83D\uDFE2 Connected' : '\uD83D\uDD34 Not configured';
  el.style.color = url ? '#2F9E5E' : '#D03030';
}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, type) {
  type = type || 'ok';
  var wrap = $('toastWrap');
  var el   = document.createElement('div');
  el.className = 'toast ' + type;
  el.innerHTML = '<div class="t-dot"></div><span>' + msg + '</span>';
  wrap.appendChild(el);
  setTimeout(function() {
    el.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(function(){ el.remove(); }, 320);
  }, 3800);
}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openModal()  { $('scriptPre').textContent = APPS_SCRIPT; $('scriptModal').classList.add('open'); }
function closeModal() { $('scriptModal').classList.remove('open'); }
function copyScript() { navigator.clipboard.writeText(APPS_SCRIPT).then(function(){ toast('Script copied to clipboard!', 'ok'); }); }

/* â”€â”€ APPS SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var APPS_SCRIPT = [
"// HIPL Production & Dispatch Tracker v4",
"// Deploy as Web App: Execute as Me | Anyone with Google Account",
"",
"const COL = { MACHINE:1, PRODUCT:2, THICKNESS:3, GRADE:4, COLOR:5, OPENING:6 };",
"const MACHINE_ORDER = ['Apollo','Parijatha PBM+','Rubber Mould','Columbia','Other'];",
"const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];",
"",
"function doPost(e) {",
"  const lock = LockService.getScriptLock();",
"  lock.waitLock(15000);",
"  try {",
"    const payload = JSON.parse(e.postData.contents);",
"    const items   = payload.batch ? payload.batch : [payload];",
"    const results = items.map(item => processEntry(item));",
"    return json({ status:'ok', processed:results.length, results });",
"  } catch(err) {",
"    return json({ status:'error', message:err.toString() });",
"  } finally {",
"    lock.releaseLock();",
"  }",
"}",
"",
"function doGet(e) {",
"  return json({ status:'ok', app:'HIPL Tracker', version:'4.0' });",
"}",
"",
"function json(obj) {",
"  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);",
"}",
"",
"function processEntry(data) {",
"  const ss   = SpreadsheetApp.getActiveSpreadsheet();",
"  const date = new Date(data.date);",
"  const sheetName = MONTH_NAMES[date.getMonth()] + '-' + String(date.getFullYear()).slice(2);",
"  let sheet = ss.getSheetByName(sheetName);",
"  if (!sheet) sheet = createMonthlySheet(ss, sheetName, date);",
"  const cols   = getOrCreateDateCols(sheet, date);",
"  const rowIdx = findRow(sheet, data);",
"  if (rowIdx > 0) {",
"    if (data.production > 0) sheet.getRange(rowIdx, cols.prod).setValue(data.production);",
"    if (data.dispatch   > 0) sheet.getRange(rowIdx, cols.disp).setValue(data.dispatch);",
"    recalcTotals(sheet, rowIdx);",
"    return { status:'updated', row:rowIdx, sheet:sheetName };",
"  } else {",
"    const at = findInsertPos(sheet, data);",
"    sheet.insertRowBefore(at);",
"    sheet.getRange(at, COL.MACHINE).setValue(data.machine || '');",
"    sheet.getRange(at, COL.PRODUCT).setValue(data.product || '');",
"    sheet.getRange(at, COL.THICKNESS).setValue(data.thickness || '');",
"    sheet.getRange(at, COL.GRADE).setValue(data.grade || '');",
"    sheet.getRange(at, COL.COLOR).setValue(data.color || '');",
"    sheet.getRange(at, COL.OPENING).setValue(0);",
"    sheet.getRange(at, cols.prod).setValue(data.production || 0);",
"    sheet.getRange(at, cols.disp).setValue(data.dispatch || 0);",
"    recalcTotals(sheet, at);",
"    return { status:'created', row:at, sheet:sheetName };",
"  }",
"}",
"",
"function findRow(sheet, data) {",
"  const last = sheet.getLastRow();",
"  if (last < 3) return -1;",
"  const vals = sheet.getRange(3, 1, last - 2, 5).getValues();",
"  for (let i = 0; i < vals.length; i++) {",
"    if (n(vals[i][0])===n(data.machine) && n(vals[i][1])===n(data.product) &&",
"        n(vals[i][2])===n(data.thickness) && n(vals[i][3])===n(data.grade||'') &&",
"        n(vals[i][4])===n(data.color||'')) return i + 3;",
"  }",
"  return -1;",
"}",
"const n = s => String(s||'').trim().toLowerCase();",
"",
"function findInsertPos(sheet, data) {",
"  const last = sheet.getLastRow();",
"  if (last < 3) return 3;",
"  const vals = sheet.getRange(3, 1, last - 2, 2).getValues();",
"  const mi   = MACHINE_ORDER.indexOf(data.machine);",
"  for (let i = 0; i < vals.length; i++) {",
"    const ri = MACHINE_ORDER.indexOf(String(vals[i][0]));",
"    if (ri > mi) return i + 3;",
"    if (ri === mi && n(vals[i][1]) > n(data.product)) return i + 3;",
"  }",
"  return last + 1;",
"}",
"",
"function getOrCreateDateCols(sheet, date) {",
"  const lastCol = sheet.getLastColumn();",
"  if (lastCol >= 7) {",
"    const row1 = sheet.getRange(1, 1, 1, lastCol).getValues()[0];",
"    for (let c = 7; c <= lastCol - 5; c += 2) {",
"      const v = row1[c-1];",
"      if (v instanceof Date && v.toDateString() === date.toDateString()) return { prod:c, disp:c+1 };",
"    }",
"  }",
"  return insertDateCols(sheet, date);",
"}",
"",
"function insertDateCols(sheet, date) {",
"  const at = sheet.getLastColumn() - 5 + 1;",
"  sheet.insertColumnsBefore(at, 2);",
"  const hdr = sheet.getRange(1, at, 1, 2);",
"  hdr.merge(); hdr.setValue(date);",
"  hdr.setNumberFormat('dd-mmm-yy'); hdr.setHorizontalAlignment('center');",
"  hdr.setBackground('#2D3748'); hdr.setFontColor('#F5A623'); hdr.setFontWeight('bold');",
"  const p = sheet.getRange(2, at);",
"  p.setValue('Prod'); p.setBackground('#2D3748'); p.setFontColor('#68D391'); p.setFontWeight('bold'); p.setHorizontalAlignment('center');",
"  const d = sheet.getRange(2, at+1);",
"  d.setValue('Disp'); d.setBackground('#2D3748'); d.setFontColor('#FC8181'); d.setFontWeight('bold'); d.setHorizontalAlignment('center');",
"  return { prod:at, disp:at+1 };",
"}",
"",
"function recalcTotals(sheet, row) {",
"  const lastCol = sheet.getLastColumn();",
"  const pairs   = lastCol - 7 - 5 + 1;",
"  if (pairs < 0) return;",
"  const vals = sheet.getRange(row, 7, 1, pairs).getValues()[0];",
"  let tp = 0, td = 0;",
"  for (let i = 0; i < vals.length; i += 2) { tp += Number(vals[i])||0; td += Number(vals[i+1])||0; }",
"  const opening = Number(sheet.getRange(row, COL.OPENING).getValue())||0;",
"  const closing = opening + tp - td;",
"  const tpCol   = lastCol - 5 + 1;",
"  sheet.getRange(row, tpCol).setValue(tp);",
"  sheet.getRange(row, tpCol+1).setValue(td);",
"  sheet.getRange(row, tpCol+2).setValue(closing);",
"}",
"",
"function createMonthlySheet(ss, sheetName, date) {",
"  const newSheet = ss.insertSheet(sheetName, 0);",
"  const prevD    = new Date(date.getFullYear(), date.getMonth()-1, 1);",
"  const prevName = MONTH_NAMES[prevD.getMonth()] + '-' + String(prevD.getFullYear()).slice(2);",
"  const prev     = ss.getSheetByName(prevName);",
"  if (prev) copyFromPrev(newSheet, prev);",
"  else       setupHeaders(newSheet);",
"  return newSheet;",
"}",
"",
"function copyFromPrev(newSheet, prevSheet) {",
"  const lastRow = prevSheet.getLastRow();",
"  const lastCol = prevSheet.getLastColumn();",
"  setupHeaders(newSheet);",
"  if (lastRow < 3) return;",
"  const rows     = prevSheet.getRange(3, 1, lastRow-2, 6).getValues();",
"  const closeCol = lastCol - 5 + 3;",
"  const closing  = closeCol >= 1 ? prevSheet.getRange(3, closeCol, lastRow-2, 1).getValues().map(r => Number(r[0])||0) : [];",
"  for (let i = 0; i < rows.length; i++) {",
"    const r = rows[i], row = i+3;",
"    newSheet.getRange(row,1).setValue(r[0]||''); newSheet.getRange(row,2).setValue(r[1]||'');",
"    newSheet.getRange(row,3).setValue(r[2]||''); newSheet.getRange(row,4).setValue(r[3]||'');",
"    newSheet.getRange(row,5).setValue(r[4]||''); newSheet.getRange(row,6).setValue(closing[i]||0);",
"  }",
"}",
"",
"function setupHeaders(sheet) {",
"  const hdrs = ['Machine Name','Product','Thickness','Grade','Colour','Opening','TP','TD','Closing','Sq. Ft.','Sq. Mtr.'];",
"  hdrs.slice(0,6).forEach((h,i) => {",
"    const c = sheet.getRange(2, i+1);",
"    c.setValue(h); c.setBackground('#1A2332'); c.setFontColor('#F5A623');",
"    c.setFontWeight('bold'); c.setHorizontalAlignment('center');",
"  });",
"  hdrs.slice(6).forEach((h,i) => {",
"    const c = sheet.getRange(2, 7+i);",
"    c.setValue(h); c.setBackground('#1A2332'); c.setFontColor('#F5A623');",
"    c.setFontWeight('bold'); c.setHorizontalAlignment('center');",
"  });",
"  [140,140,90,70,95,80].forEach((w,i) => sheet.setColumnWidth(i+1,w));",
"  sheet.setFrozenRows(2); sheet.setFrozenColumns(6);",
"}"
].join("\n");

</script>
</body>
</html>
