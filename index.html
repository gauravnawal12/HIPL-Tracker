<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!--
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    HIPL PRODUCTION & DISPATCH TRACKER  Â·  v3
    Helix Industries Private Limited
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    PWA â€” works offline, installable on phone home screen.
    Multi-entry batch UI â€” add many rows, submit once.
    Syncs to Google Sheets via Apps Script Web App (no-cors POST).
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <meta name="theme-color" content="#111923"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="description" content="Helix Industries Production & Dispatch Tracker"/>
  <link rel="manifest" href="manifest.json"/>
  <title>HIPL Â· Production &amp; Dispatch</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CSS CUSTOM PROPERTIES â€” single source of truth for theming
       Colours derived from the Helix Industries logo palette.
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      /* Brand */
      --gold:        #F5A623;
      --gold-dark:   #C4841A;
      --gold-dim:    rgba(245,166,35,0.13);
      --gold-border: rgba(245,166,35,0.28);

      /* Slate palette (logo dark tones) */
      --slate-900:  #111923;
      --slate-800:  #1A2332;
      --slate-700:  #243044;
      --slate-600:  #2D3B52;
      --slate-500:  #3D4F63;

      /* Text */
      --white:     #FFFFFF;
      --text-mid:  rgba(255,255,255,0.70);
      --text-dim:  rgba(255,255,255,0.40);

      /* Surfaces */
      --surface:   rgba(255,255,255,0.05);
      --border:    rgba(255,255,255,0.07);
      --border-md: rgba(255,255,255,0.13);

      /* Semantic colours */
      --green:     #38A169;
      --green-dim: rgba(56,161,105,0.11);
      --green-bdr: rgba(56,161,105,0.24);
      --red:       #E53E3E;
      --red-dim:   rgba(229,62,62,0.09);
      --red-bdr:   rgba(229,62,62,0.22);

      /* Shape */
      --r:    10px;
      --r-sm:  7px;
    }

    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; -webkit-tap-highlight-color:transparent; }
    body {
      font-family:'Barlow', sans-serif;
      background:var(--slate-800);
      color:var(--white);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Subtle diagonal grid texture overlay */
    body::before {
      content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(ellipse 65% 55% at 4% 2%,   rgba(245,166,35,0.07) 0%, transparent 65%),
        radial-gradient(ellipse 45% 55% at 96% 98%,  rgba(17,25,35,0.95)  0%, transparent 65%),
        repeating-linear-gradient(135deg, transparent 0, transparent 46px,rgba(255,255,255,0.011) 46px,rgba(255,255,255,0.011) 47px),
        repeating-linear-gradient(45deg,  transparent 0, transparent 46px,rgba(255,255,255,0.007) 46px,rgba(255,255,255,0.007) 47px);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STICKY HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .hdr {
      position:sticky; top:0; z-index:200;
      background:rgba(17,25,35,0.93);
      backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
      border-bottom:1px solid var(--border);
    }
    .hdr-inner {
      max-width:900px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; height:62px;
    }

    /* Logo: 2Ã—2 grid recreating the Helix H-block mark */
    .logo { display:flex; align-items:center; gap:13px; }
    .logo-mark {
      width:38px; height:38px; flex-shrink:0;
      display:grid; grid-template-columns:1fr 1fr; gap:3px;
    }
    .lm-tl { background:var(--slate-600); border-radius:2px 0 0 0; }
    .lm-tr { background:var(--gold); border-radius:0 2px 0 0; position:relative; overflow:hidden; }
    .lm-tr::after { /* diagonal cut on gold cell */
      content:''; position:absolute; bottom:0; right:0;
      border-style:solid; border-width:0 0 11px 11px;
      border-color:transparent transparent var(--slate-800) transparent;
    }
    .lm-bl { background:var(--gold);      border-radius:0 0 0 2px; }
    .lm-br { background:var(--slate-600); border-radius:0 0 2px 0; }
    .logo-words h1 {
      font-family:'Barlow Condensed',sans-serif;
      font-size:19px; font-weight:800; letter-spacing:3.5px; text-transform:uppercase;
      color:var(--white); line-height:1;
    }
    .logo-words p {
      font-size:9px; letter-spacing:2.5px; text-transform:uppercase;
      color:var(--gold); font-weight:600; margin-top:3px;
    }

    /* Header right: live entry count pill + product badge */
    .hdr-right { display:flex; align-items:center; gap:8px; }
    .count-pill {
      display:none; /* JS shows this when entries > 0 */
      background:var(--gold-dim); border:1px solid var(--gold-border);
      color:var(--gold); font-family:'Barlow Condensed',sans-serif;
      font-size:11px; font-weight:800; letter-spacing:1px;
      padding:4px 11px; border-radius:20px; white-space:nowrap;
    }
    .count-pill.show { display:block; }
    .hdr-pill {
      background:linear-gradient(135deg,var(--gold),var(--gold-dark));
      color:var(--slate-900);
      font-family:'Barlow Condensed',sans-serif;
      font-size:10px; font-weight:800; letter-spacing:2px; text-transform:uppercase;
      padding:5px 12px; border-radius:20px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LAYOUT
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    main {
      position:relative; z-index:1;
      max-width:900px; margin:0 auto;
      padding:26px 18px 120px;
    }

    /* Page heading */
    .pg-head { margin-bottom:22px; }
    .pg-head h2 {
      font-family:'Barlow Condensed',sans-serif;
      font-size:33px; font-weight:900; line-height:1.05;
    }
    .pg-head h2 em { color:var(--gold); font-style:normal; }
    .pg-head p { font-size:13px; color:var(--text-dim); margin-top:5px; font-weight:300; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       OFFLINE BANNER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .offline-bar {
      display:none; align-items:center; gap:8px;
      background:var(--red-dim); border:1px solid var(--red-bdr);
      border-radius:var(--r-sm); padding:9px 14px;
      font-size:12px; color:#FC8181; margin-bottom:16px;
    }
    .offline-bar.on { display:flex; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATE STRIP â€” batch date shared across all entries
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .date-strip {
      display:flex; align-items:center;
      background:linear-gradient(135deg,rgba(245,166,35,0.12),rgba(245,166,35,0.04));
      border:1px solid var(--gold-border);
      border-radius:var(--r); padding:13px 18px; margin-bottom:22px;
    }
    .date-icon {
      width:36px; height:36px; flex-shrink:0;
      background:linear-gradient(135deg,var(--gold),var(--gold-dark));
      border-radius:7px; display:flex; align-items:center;
      justify-content:center; font-size:16px; margin-right:14px;
    }
    .date-lbl {
      font-size:10px; letter-spacing:2.5px; text-transform:uppercase;
      color:var(--gold); font-weight:700; margin-bottom:3px;
    }
    .date-strip input[type="date"] {
      background:transparent; border:none; outline:none;
      font-family:'Barlow Condensed',sans-serif;
      font-size:21px; font-weight:700; color:var(--white);
      letter-spacing:1px; cursor:pointer; padding:0;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter:invert(1) sepia(1) saturate(4) hue-rotate(5deg);
      cursor:pointer; opacity:0.55; margin-left:8px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SECTION HEADER above entry cards
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .sec-hdr {
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .sec-hdr-left {
      font-family:'Barlow Condensed',sans-serif;
      font-size:12px; font-weight:700; letter-spacing:3px;
      text-transform:uppercase; color:var(--text-dim);
      display:flex; align-items:center; gap:8px;
    }
    .sec-count {
      background:var(--gold-dim); border:1px solid var(--gold-border);
      color:var(--gold); font-family:'Barlow Condensed',sans-serif;
      font-size:11px; font-weight:800; padding:1px 8px; border-radius:20px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ENTRY CARDS STACK
       Each card = one row of material data
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #entryCards { display:flex; flex-direction:column; gap:14px; }

    /* Single entry card */
    .ecard {
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--r);
      overflow:hidden;
      animation:fadeIn .22s ease;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(-8px); }
      to   { opacity:1; transform:translateY(0); }
    }
    /* Error state â€” red border when validation fails on submit */
    .ecard.err  { border-color:var(--red-bdr); box-shadow:0 0 0 1px var(--red-bdr); }
    /* Valid state â€” green border when all required fields are filled */
    .ecard.ok   { border-color:var(--green-bdr); }

    /* â”€â”€ Card Header (click to collapse/expand) â”€â”€ */
    .ec-hdr {
      display:flex; align-items:center; gap:10px;
      padding:12px 16px;
      background:rgba(255,255,255,0.022);
      border-bottom:1px solid var(--border);
      cursor:pointer; user-select:none;
      transition:background .15s;
    }
    .ec-hdr:hover { background:rgba(255,255,255,0.04); }

    /* Gold number badge (1, 2, 3â€¦) */
    .ec-badge {
      width:24px; height:24px; flex-shrink:0; border-radius:50%;
      background:linear-gradient(135deg,var(--gold),var(--gold-dark));
      display:flex; align-items:center; justify-content:center;
      font-family:'Barlow Condensed',sans-serif; font-size:12px;
      font-weight:900; color:var(--slate-900);
    }

    /* Title shown when card is empty/not yet filled */
    .ec-title {
      flex:1; font-family:'Barlow Condensed',sans-serif;
      font-size:14px; font-weight:700; letter-spacing:1.5px;
      text-transform:uppercase; color:var(--text-mid);
    }
    /* Summary shown in place of title when card is populated + collapsed */
    .ec-summary { flex:1; font-size:13px; color:var(--text-mid); line-height:1.3; }
    .ec-summary b { color:var(--white); }
    .ec-summary small { color:var(--text-dim); font-size:11px; }

    /* Small dot: grey = empty, green = valid, red = has error */
    .ec-dot {
      width:7px; height:7px; border-radius:50%; flex-shrink:0;
      background:var(--border-md);
    }
    .ecard.ok  .ec-dot { background:var(--green); }
    .ecard.err .ec-dot { background:var(--red);   }

    /* Remove card button (Ã—) */
    .ec-del {
      background:none; border:none; cursor:pointer;
      color:var(--text-dim); font-size:18px; line-height:1;
      padding:2px 5px; border-radius:4px;
      transition:color .15s, background .15s;
    }
    .ec-del:hover { color:#FC8181; background:var(--red-dim); }

    /* Collapse/expand chevron */
    .ec-chev {
      color:var(--text-dim); font-size:11px;
      transition:transform .2s; flex-shrink:0;
    }
    .ecard.collapsed .ec-chev { transform:rotate(-90deg); }

    /* â”€â”€ Card Body (collapsible) â”€â”€ */
    .ec-body { padding:16px; }
    .ecard.collapsed .ec-body { display:none; }

    /* â”€â”€ Form grid: 3 cols desktop â†’ 2 cols tablet â†’ 1 col mobile â”€â”€ */
    .eg {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    /* Field wrapper */
    .ef { display:flex; flex-direction:column; gap:5px; }
    .ef.s2 { grid-column:span 2; }
    .ef.s3 { grid-column:1/-1;  }

    /* Field label */
    .el {
      font-size:9.5px; letter-spacing:2px; text-transform:uppercase;
      font-weight:700; color:var(--text-dim);
      display:flex; align-items:center; gap:3px;
    }
    .el .req { color:var(--gold); font-size:13px; line-height:1; }

    /* â”€â”€ Shared input / select styles â”€â”€ */
    select, input[type="text"], input[type="number"] {
      width:100%; background:rgba(255,255,255,0.055);
      border:1px solid rgba(255,255,255,0.09);
      border-radius:var(--r-sm); padding:9px 12px;
      color:var(--white); font-family:'Barlow',sans-serif;
      font-size:13px; font-weight:500; outline:none;
      transition:border-color .18s, box-shadow .18s, background .18s;
      -webkit-appearance:none; appearance:none;
    }
    /* Gold custom arrow */
    select {
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' viewBox='0 0 24 24' fill='none' stroke='%23F5A623' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 10px center;
      padding-right:32px; cursor:pointer;
    }
    select option { background:var(--slate-700); color:var(--white); }
    select:focus, input:focus {
      border-color:var(--gold);
      background:rgba(245,166,35,0.07);
      box-shadow:0 0 0 3px rgba(245,166,35,0.09);
    }
    select.ferr, input.ferr {
      border-color:var(--red);
      box-shadow:0 0 0 2px rgba(229,62,62,0.1);
    }
    select:disabled { opacity:0.35; cursor:not-allowed; }
    .ferr-txt { font-size:11px; color:#FC8181; }

    /* "Other" text input: hidden until "Other" chosen in dropdown */
    .other-inp { display:none; margin-top:6px; }

    /* â”€â”€ Production / Dispatch mini cards â”€â”€ */
    .pd-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px; }
    .pd-box { border-radius:var(--r-sm); padding:12px 14px; }
    .pd-box.prod { background:var(--green-dim); border:1px solid var(--green-bdr); }
    .pd-box.disp { background:var(--red-dim);   border:1px solid var(--red-bdr);   }
    .pd-box.prod .el  { color:rgba(104,211,145,0.85); }
    .pd-box.disp .el  { color:rgba(252,129,129,0.85); }
    .pd-box.prod input { border-color:var(--green-bdr); }
    .pd-box.disp input { border-color:var(--red-bdr);   }
    .pd-box.prod input:focus { border-color:var(--green); box-shadow:0 0 0 3px rgba(56,161,105,0.14); }
    .pd-box.disp input:focus { border-color:var(--red);   box-shadow:0 0 0 3px rgba(229,62,62,0.1);   }
    .pd-hint { font-size:11px; margin-top:4px; }
    .prod .pd-hint { color:rgba(56,161,105,0.5); }
    .disp .pd-hint { color:rgba(229,62,62,0.4);  }

    /* â”€â”€ Sq. Ft. / Sq. Mtr. conversion preview â”€â”€ */
    .conv-box {
      display:none; /* shown by JS when factor exists and qty > 0 */
      background:rgba(245,166,35,0.07); border:1px solid var(--gold-border);
      border-radius:var(--r-sm); padding:9px 13px;
      font-size:12px; color:var(--gold); line-height:1.65;
    }
    .conv-box.show { display:block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ADD ENTRY BUTTON â€” dashed call-to-action below cards
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .add-btn {
      width:100%; display:flex; align-items:center; justify-content:center; gap:10px;
      padding:14px; background:transparent;
      border:2px dashed rgba(245,166,35,0.28); border-radius:var(--r);
      color:var(--gold); cursor:pointer;
      font-family:'Barlow Condensed',sans-serif; font-size:14px;
      font-weight:700; letter-spacing:2px; text-transform:uppercase;
      transition:background .18s, border-color .18s;
      margin-top:4px;
    }
    .add-btn:hover { background:var(--gold-dim); border-color:rgba(245,166,35,0.5); }
    .add-btn .plus {
      width:26px; height:26px; border-radius:50%;
      background:var(--gold-dim); border:1px solid var(--gold-border);
      display:flex; align-items:center; justify-content:center;
      font-size:18px; line-height:1;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BATCH SUMMARY BAR
       Shows "X entries ready Â· Total Prod Y pcs Â· Total Disp Z pcs"
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .batch-bar {
      display:none; /* shown by JS when â‰¥1 valid entry exists */
      align-items:center; gap:14px;
      background:var(--gold-dim); border:1px solid var(--gold-border);
      border-radius:var(--r); padding:14px 18px; margin-top:18px;
    }
    .batch-bar.show { display:flex; }
    .bb-icon { font-size:20px; flex-shrink:0; }
    .bb-text { flex:1; }
    .bb-text strong {
      font-family:'Barlow Condensed',sans-serif;
      font-size:16px; font-weight:800; color:var(--gold); display:block;
    }
    .bb-text span { font-size:12px; color:var(--text-dim); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACTION ROW
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .actions { display:flex; gap:10px; margin-top:14px; }

    /* Primary CTA â€” gold gradient */
    .btn-primary {
      flex:1; background:linear-gradient(135deg,var(--gold),var(--gold-dark));
      border:none; border-radius:var(--r-sm); padding:14px 20px;
      color:var(--slate-900); font-family:'Barlow Condensed',sans-serif;
      font-size:15px; font-weight:900; letter-spacing:2px; text-transform:uppercase;
      cursor:pointer; transition:transform .15s, box-shadow .15s;
      position:relative; overflow:hidden;
    }
    .btn-primary::after {
      content:''; position:absolute; inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.18),transparent);
      opacity:0; transition:opacity .18s;
    }
    .btn-primary:hover::after { opacity:1; }
    .btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 28px rgba(245,166,35,0.28); }
    .btn-primary:active { transform:translateY(0); }
    .btn-primary:disabled { opacity:0.55; cursor:not-allowed; transform:none; }

    /* Ghost secondary */
    .btn-ghost {
      background:transparent; border:1px solid var(--border-md);
      border-radius:var(--r-sm); padding:14px 18px; color:var(--text-dim);
      font-family:'Barlow Condensed',sans-serif; font-size:13px;
      font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
      cursor:pointer; transition:border-color .15s, color .15s;
    }
    .btn-ghost:hover { border-color:var(--border-md); color:var(--text-mid); }

    /* Loading spinner (inside submit button) */
    .spin {
      display:inline-block; width:13px; height:13px;
      border:2px solid rgba(26,35,50,0.3); border-top-color:var(--slate-900);
      border-radius:50%; animation:rot .6s linear infinite; vertical-align:middle;
    }
    @keyframes rot { to { transform:rotate(360deg); } }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETTINGS â€” Google Sheets connection
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cfg-wrap { margin-top:20px; }
    .cfg-toggle {
      display:flex; align-items:center; gap:9px;
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r-sm); padding:11px 15px;
      font-size:12px; color:var(--text-dim); cursor:pointer;
      user-select:none; transition:border-color .15s, color .15s;
    }
    .cfg-toggle:hover { border-color:var(--border-md); color:var(--text-mid); }
    .cfg-toggle .arr { font-size:10px; transition:transform .2s; }
    .cfg-toggle.open .arr { transform:rotate(90deg); }
    .cfg-panel {
      display:none; flex-direction:column; gap:14px;
      background:var(--surface); border:1px solid var(--border);
      border-top:none; border-radius:0 0 var(--r-sm) var(--r-sm); padding:18px;
    }
    .cfg-panel.open { display:flex; }
    .cfg-panel label {
      font-size:10px; letter-spacing:2px; text-transform:uppercase;
      color:var(--text-dim); font-weight:700; display:block; margin-bottom:5px;
    }
    .cfg-note { font-size:12px; color:var(--text-dim); line-height:1.75; }
    .cfg-note strong { color:var(--gold); }
    .script-link { color:var(--gold); font-size:12px; text-decoration:underline; cursor:pointer; }
    .btn-save-cfg {
      align-self:flex-start; background:transparent;
      border:1px solid var(--gold-border); border-radius:var(--r-sm);
      padding:9px 18px; color:var(--gold);
      font-family:'Barlow Condensed',sans-serif; font-size:13px;
      font-weight:700; letter-spacing:1.5px; text-transform:uppercase;
      cursor:pointer; transition:background .15s;
    }
    .btn-save-cfg:hover { background:var(--gold-dim); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RECENT SUBMISSIONS LOG â€” shows past batches from localStorage
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .log-section { margin-top:36px; }
    .log-title {
      font-family:'Barlow Condensed',sans-serif;
      font-size:11px; font-weight:700; letter-spacing:3px; text-transform:uppercase;
      color:rgba(255,255,255,0.28);
      display:flex; align-items:center; gap:10px; margin-bottom:12px;
    }
    .log-title::after { content:''; flex:1; height:1px; background:var(--border); }
    .log-batch {
      background:var(--surface); border:1px solid var(--border);
      border-radius:var(--r); overflow:hidden; margin-bottom:10px;
      animation:fadeIn .22s ease;
    }
    .log-batch-hdr {
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; background:rgba(255,255,255,0.022);
      border-bottom:1px solid var(--border); font-size:12px;
    }
    .lbh-date { font-family:'Barlow Condensed',sans-serif; font-weight:700; color:var(--gold); font-size:13px; }
    .lbh-count { color:var(--text-dim); }
    .lbh-time  { margin-left:auto; color:rgba(255,255,255,0.22); font-size:11px; }
    .log-row {
      display:flex; align-items:center; gap:10px;
      padding:9px 14px; border-bottom:1px solid var(--border); font-size:12px;
    }
    .log-row:last-child { border-bottom:none; }
    .log-machine {
      background:var(--gold-dim); border:1px solid var(--gold-border);
      color:var(--gold); font-family:'Barlow Condensed',sans-serif;
      font-size:10px; font-weight:800; letter-spacing:1px; text-transform:uppercase;
      padding:2px 7px; border-radius:3px; flex-shrink:0;
    }
    .log-info { flex:1; min-width:0; }
    .log-info b { color:var(--white); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }
    .log-info span { color:var(--text-dim); font-size:11px; }
    .log-qty { display:flex; gap:7px; flex-shrink:0; }
    .lqp { color:#68D391; font-weight:700; }
    .lqd { color:#FC8181; font-weight:700; }
    .log-empty { text-align:center; padding:28px; font-size:13px; color:rgba(255,255,255,0.2); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCRIPT MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      display:none; position:fixed; inset:0; z-index:500;
      background:rgba(0,0,0,0.9); backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px); padding:20px; overflow-y:auto;
    }
    .modal-overlay.open { display:block; }
    .modal-box {
      max-width:720px; margin:40px auto;
      background:var(--slate-700); border:1px solid var(--border);
      border-radius:var(--r); overflow:hidden;
    }
    .modal-hdr {
      padding:16px 22px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-hdr h3 { font-family:'Barlow Condensed',sans-serif; font-size:17px; font-weight:800; letter-spacing:1px; }
    .modal-close { background:none; border:none; color:var(--text-dim); font-size:22px; cursor:pointer; line-height:1; }
    .modal-body  { padding:22px; }
    .modal-note  { font-size:13px; color:var(--text-dim); margin-bottom:14px; line-height:1.7; }
    .modal-steps { font-size:13px; color:var(--text-mid); line-height:2; margin-bottom:14px; }
    .modal-steps strong { color:var(--gold); }
    pre#scriptPre {
      background:#0D1117; border:1px solid rgba(255,255,255,0.07);
      border-radius:8px; padding:16px; font-size:11px;
      color:#c9d1d9; line-height:1.65; white-space:pre-wrap;
      max-height:380px; overflow-y:auto;
    }
    .btn-copy {
      margin-top:12px;
      background:linear-gradient(135deg,var(--gold),var(--gold-dark));
      border:none; border-radius:8px; padding:10px 20px;
      color:var(--slate-900); font-family:'Barlow Condensed',sans-serif;
      font-weight:800; letter-spacing:1.5px; font-size:13px; cursor:pointer;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST NOTIFICATIONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .toast-wrap {
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
      z-index:999; display:flex; flex-direction:column; align-items:center; gap:8px;
      pointer-events:none;
    }
    .toast {
      display:flex; align-items:center; gap:9px;
      background:var(--slate-600); border:1px solid var(--border);
      border-radius:40px; padding:11px 20px;
      font-size:13px; font-weight:500;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
      animation:fadeIn .25s ease; max-width:380px; text-align:center;
      pointer-events:auto;
    }
    .toast.ok  { background:rgba(56,161,105,0.18);  border-color:rgba(56,161,105,0.35);  }
    .toast.err { background:rgba(229,62,62,0.15);   border-color:rgba(229,62,62,0.35);   }
    .toast.inf { background:rgba(245,166,35,0.12);  border-color:rgba(245,166,35,0.3);   }
    .t-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
    .toast.ok  .t-dot { background:var(--green); }
    .toast.err .t-dot { background:var(--red);   }
    .toast.inf .t-dot { background:var(--gold); animation:blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media(max-width:680px) {
      .eg          { grid-template-columns:1fr 1fr; }
      .ef.s2       { grid-column:1/-1; }
    }
    @media(max-width:440px) {
      .eg          { grid-template-columns:1fr; }
      .ef.s2,.ef.s3{ grid-column:auto; }
      .pd-row      { grid-template-columns:1fr; }
      .pg-head h2  { font-size:26px; }
      .hdr-pill    { display:none; }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="hdr">
  <div class="hdr-inner">
    <div class="logo">
      <div class="logo-mark">
        <div class="lm-tl"></div><div class="lm-tr"></div>
        <div class="lm-bl"></div><div class="lm-br"></div>
      </div>
      <div class="logo-words">
        <h1>Helix Industries</h1>
        <p>Quality Redefined</p>
      </div>
    </div>
    <div class="hdr-right">
      <!-- Live count: "2/3 ready" â€” shown when entry cards exist -->
      <div class="count-pill" id="hdrCount"></div>
      <div class="hdr-pill">Prod &amp; Dispatch</div>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main>

  <div class="pg-head">
    <h2>Production &amp; <em>Dispatch</em> Entry</h2>
    <p>Fill in all entries for the day, then submit everything to Google Sheets at once</p>
  </div>

  <!-- Offline warning -->
  <div class="offline-bar" id="offlineBar">
    <span>âš¡</span> You're offline â€” entries will queue and sync automatically when reconnected.
  </div>

  <!-- Batch date picker â€” applies to all entries in this batch -->
  <div class="date-strip">
    <div class="date-icon">ğŸ“…</div>
    <div>
      <div class="date-lbl">Batch Date</div>
      <input type="date" id="batchDate" onchange="refreshBatchBar()"/>
    </div>
  </div>

  <!-- â”€â”€ ENTRIES SECTION â”€â”€ -->
  <div class="sec-hdr">
    <div class="sec-hdr-left">
      Entries
      <span class="sec-count" id="secCount">0</span>
    </div>
  </div>

  <!-- Entry cards are injected here by addEntry() -->
  <div id="entryCards"></div>

  <!-- Add another entry CTA -->
  <button class="add-btn" onclick="addEntry()">
    <span class="plus">+</span>
    Add Another Entry
  </button>

  <!-- Batch summary bar: appears when â‰¥1 card is valid -->
  <div class="batch-bar" id="batchBar">
    <span class="bb-icon">ğŸ“‹</span>
    <div class="bb-text">
      <strong id="bbMain">0 entries ready</strong>
      <span id="bbDetail"></span>
    </div>
  </div>

  <!-- Primary actions -->
  <div class="actions">
    <button class="btn-ghost" onclick="clearAll()">âœ• Clear All</button>
    <button class="btn-primary" id="btnSubmit" onclick="submitAll()">
      Submit All Entries
    </button>
  </div>

  <!-- â”€â”€ SETTINGS â”€â”€ -->
  <div class="cfg-wrap">
    <div class="cfg-toggle" id="cfgToggle" onclick="toggleCfg()">
      <span class="arr">â–¶</span>
      <span>âš™ Google Sheets Integration</span>
      <span id="cfgStatus" style="margin-left:auto;font-size:11px;"></span>
    </div>
    <div class="cfg-panel" id="cfgPanel">
      <div>
        <label>Google Apps Script Web App URL</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/â€¦/exec"/>
      </div>

      <!-- Test result box: shown after clicking Test Connection -->
      <div id="testResult" style="display:none;border-radius:7px;padding:11px 14px;font-size:12px;line-height:1.7;margin-top:2px;"></div>

      <div class="cfg-note">
        <strong>How to connect:</strong><br>
        1. Open your Google Sheet â†’ Extensions â†’ Apps Script<br>
        2. Paste the provided script (link below) â†’ Save (ğŸ’¾)<br>
        3. Deploy â†’ New Deployment â†’ Web App<br>
        &nbsp;&nbsp;&nbsp;Â· Execute as: <strong>Me</strong><br>
        &nbsp;&nbsp;&nbsp;Â· Who has access: <strong>Anyone with Google Account</strong><br>
        4. Paste the Web App URL above â†’ Save Settings â†’ Test Connection.<br><br>
        âš ï¸ <strong>Important:</strong> Every time you edit the script, you must create a
        <strong>New Deployment</strong> â€” do not redeploy the same one.<br><br>
        <span class="script-link" onclick="openModal()">ğŸ“‹ View &amp; copy the Google Apps Script â†’</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-save-cfg" onclick="saveSettings()">Save Settings</button>
        <button class="btn-save-cfg" id="btnTest" onclick="testConnection()" style="border-color:rgba(104,211,145,0.3);color:#68D391;">ğŸ”Œ Test Connection</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ RECENT SUBMISSIONS LOG â”€â”€ -->
  <div class="log-section">
    <div class="log-title">Recent Submissions</div>
    <div id="logList"></div>
  </div>

</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APPS SCRIPT MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="scriptModal">
  <div class="modal-box">
    <div class="modal-hdr">
      <h3>Google Apps Script â€” Setup Code</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="modal-note">
        Copy this entire script into your Google Sheet's Apps Script editor, then
        deploy it as a Web App. It handles batch inserts, monthly sheet creation with
        Opening Stock carry-forward, date column management, and Closing Stock recalculation.
      </p>
      <div class="modal-steps">
        <strong>Extensions â†’ Apps Script â†’ Paste â†’ Save â†’ Deploy â†’ New Deployment â†’ Web App</strong><br>
        Execute as: <strong>Me</strong> &nbsp;|&nbsp; Access: <strong>Anyone with Google Account</strong><br>
        âš ï¸ After any edits, always create a <strong>New Deployment</strong> (not redeploy same URL).
      </div>
      <pre id="scriptPre"></pre>
      <button class="btn-copy" onclick="copyScript()">ğŸ“‹ Copy Script to Clipboard</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATIC DATA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/**
 * MACHINE_PRODUCTS
 * Maps each machine name â†’ array of product names.
 * This drives the Product dropdown (populated after Machine is chosen).
 * Add / remove products here to update all dropdowns automatically.
 */
const MACHINE_PRODUCTS = {
  'Apollo': [
    'Hexagon', '8x8 Quad', '8x4',
    'Kerbstone Round', 'Kerbstone Chamfered', 'Kerbstone Bullnose'
  ],
  'Parijatha PBM+': [
    'Hexagon', 'Zigzag', 'I-Shape', '8x4', 'Tricon', 'S-Paver'
  ],
  'Rubber Mould': [
    'Jumbo', 'Zigzag', 'Euphrates', 'River Quad', '3D Hexa',
    'Cobble', '8x4', '4x4', 'Cobble 4.5"', 'X-Block',
    'Cover Block Big', 'Cover Block Small', '36 Striker',
    'Cross Strip', 'Matrix', 'Riveira',
    'BB Bali', 'BB Aruba', 'BB Maui', 'BB Maldives',
    'BB Ibiza', 'BB Barbados', 'Cool Roof Tile', 'Drain Channel'
  ],
  'Columbia': [], // Products to be added when ready
  'Other':    []
};

/**
 * CONV â€” Sq. Ft. conversion factors (pieces per sq ft).
 * Key format: "Machine|Product"
 * Formula:  sqFt  = pieces / factor
 *           sqMtr = sqFt Ã— 0.092903
 * Products not listed here will leave Sq. Ft. / Sq. Mtr. blank.
 */
const CONV = {
  'Apollo|Hexagon':              2.50,
  'Apollo|8x8 Quad':             2.25,
  'Apollo|8x4':                  4.50,
  'Apollo|Kerbstone Round':      1.00,
  'Apollo|Kerbstone Chamfered':  1.00,
  'Apollo|Kerbstone Bullnose':   1.00,
  'Parijatha PBM+|Hexagon':      2.50,
  'Parijatha PBM+|Zigzag':       3.50,
  'Parijatha PBM+|I-Shape':      3.25,
  'Parijatha PBM+|8x4':          4.50,
  'Parijatha PBM+|Tricon':       2.90,
  'Parijatha PBM+|S-Paver':      4.50,
  'Rubber Mould|Jumbo':          1.80,
  'Rubber Mould|Zigzag':         2.80,
  'Rubber Mould|Euphrates':      2.50,
  'Rubber Mould|River Quad':     2.25,
  'Rubber Mould|3D Hexa':        2.50,
  'Rubber Mould|Cobble':         2.25,
  'Rubber Mould|8x4':            4.50,
  'Rubber Mould|4x4':            9.00,
  'Rubber Mould|Cobble 4.5"':    7.11,
  'Rubber Mould|X-Block':        1.44,
  'Rubber Mould|36 Striker':     1.00,
  'Rubber Mould|Cross Strip':    1.00,
  'Rubber Mould|Matrix':         1.00,
  'Rubber Mould|BB Bali':        2.25,
  'Rubber Mould|BB Aruba':       2.25,
  'Rubber Mould|BB Maui':        2.25,
  'Rubber Mould|BB Maldives':    2.25,
  'Rubber Mould|BB Ibiza':       2.25,
  'Rubber Mould|BB Barbados':    2.25,
  'Rubber Mould|Cool Roof Tile': 1.00,
  'Rubber Mould|Drain Channel':  1.00
  // Cover Block Big / Small / Riveira â€” no conversion provided
};

const SQM_PER_SQFT = 0.092903; // conversion constant

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
   All mutable state lives here (no hidden fields / global mutations).
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let nextId  = 0;  // Auto-incrementing ID assigned to each new entry card
let entries = []; // Array of { id, valid } â€” one per visible card

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', () => {

  // Pre-fill batch date with today's date
  const t = new Date();
  document.getElementById('batchDate').value =
    `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}`;

  // Restore saved Google Script URL
  const savedUrl = localStorage.getItem('hipl_url') || '';
  document.getElementById('scriptUrl').value = savedUrl;
  updateCfgStatus();

  // Start with one blank entry card
  addEntry();

  // Load submission history into the log
  renderLog();

  // Online/offline handlers
  const ob = document.getElementById('offlineBar');
  window.addEventListener('offline', () => ob.classList.add('on'));
  window.addEventListener('online',  () => { ob.classList.remove('on'); syncQueue(); });
  if (!navigator.onLine) ob.classList.add('on');

  // Register service worker for offline caching + background sync
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('message', e => {
      if (e.data?.type === 'SYNC_NOW') syncQueue();
    });
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UTILITIES
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const pad  = n => String(n).padStart(2, '0');              // "5" â†’ "05"
const norm = s => String(s || '').trim().toLowerCase();    // for comparisons
const $    = id => document.getElementById(id);            // shorthand
const val  = id => ($(id)?.value || '').trim();            // get trimmed field value

/* Get the card element for a given entry id */
const card = id => $(`ec-${id}`);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ADD ENTRY CARD
   Creates a new blank card, appends it to the DOM, and collapses
   all previous cards so focus goes to the new one.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function addEntry() {
  nextId++;
  const id = nextId;
  entries.push({ id, valid: false });

  // Inject card HTML into the DOM
  $('entryCards').insertAdjacentHTML('beforeend', buildCardHTML(id));

  // Collapse all cards except the new one
  entries.slice(0, -1).forEach(e => collapseCard(e.id));

  // Update counters
  refreshCounters();

  // Scroll new card into view
  setTimeout(() => card(id)?.scrollIntoView({ behavior:'smooth', block:'nearest' }), 60);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BUILD CARD HTML
   Returns a complete HTML string for one entry card with the given id.
   All element IDs are namespaced with the id (e.g. machine-3, prod-3).
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildCardHTML(id) {

  // â”€â”€ Option builders â”€â”€
  const machineOpts = Object.keys(MACHINE_PRODUCTS)
    .map(m => `<option value="${m}">${m}</option>`).join('');

  const thicknessOpts = ['20 MM','25 MM','30 MM','60 MM','75 MM','80 MM','100 MM','150 MM']
    .map(t => `<option value="${t}">${t}</option>`).join('');

  const gradeOpts = ['M-7.5','M-12.5','M-25','M-30','M-35','M-40','M-50']
    .map(g => `<option value="${g}">${g}</option>`).join('');

  const colourOpts = ['Grey','Dark Grey','Red','Yellow','Chocolate','Orange','White','Blue','Green']
    .map(c => `<option value="${c}">${c}</option>`).join('');

  return `
  <div class="ecard" id="ec-${id}">

    <!-- â”€â”€ Card Header: number badge, title/summary, status dot, remove btn, chevron â”€â”€ -->
    <div class="ec-hdr" onclick="toggleCollapse(${id})">
      <div class="ec-badge" id="ecb-${id}">${entries.length}</div>

      <!-- Title shown when card is unfilled -->
      <div class="ec-title" id="ect-${id}">New Entry</div>

      <!-- One-line summary shown when card is collapsed and has data -->
      <div class="ec-summary" id="ecs-${id}" style="display:none"></div>

      <!-- Validity dot -->
      <div class="ec-dot" id="ecd-${id}"></div>

      <!-- Chevron (â–¼ when open, rotated when collapsed) -->
      <span class="ec-chev">â–¼</span>

      <!-- Remove this card (stops click-to-collapse from also firing) -->
      <button class="ec-del" onclick="removeEntry(event,${id})" title="Remove this entry">âœ•</button>
    </div>

    <!-- â”€â”€ Card Body â”€â”€ -->
    <div class="ec-body" id="ecbd-${id}">

      <!-- Row 1: Machine Â· Product Â· Thickness Â· Grade Â· Colour -->
      <div class="eg">

        <!-- Machine Name (mandatory) -->
        <div class="ef">
          <label class="el" for="machine-${id}">Machine <span class="req">*</span></label>
          <select id="machine-${id}" onchange="onMachine(${id})">
            <option value="">â€” Select â€”</option>
            ${machineOpts}
          </select>
          <span class="ferr-txt" id="fe-machine-${id}"></span>
        </div>

        <!-- Product (mandatory, populated after Machine chosen) -->
        <div class="ef">
          <label class="el" for="product-${id}">Product <span class="req">*</span></label>
          <select id="product-${id}" disabled onchange="onProduct(${id})">
            <option value="">â€” Select Machine First â€”</option>
          </select>
          <span class="ferr-txt" id="fe-product-${id}"></span>
        </div>

        <!-- Thickness (mandatory) -->
        <div class="ef">
          <label class="el" for="thickness-${id}">Thickness <span class="req">*</span></label>
          <select id="thickness-${id}" onchange="onThickness(${id})">
            <option value="">â€” Select â€”</option>
            ${thicknessOpts}
            <option value="Other">Other</option>
          </select>
          <!-- Free-text field shown when "Other" is picked -->
          <input type="text" id="thick-other-${id}" class="other-inp" placeholder="Specify thicknessâ€¦"/>
          <span class="ferr-txt" id="fe-thickness-${id}"></span>
        </div>

        <!-- Grade (optional) -->
        <div class="ef">
          <label class="el" for="grade-${id}">Grade</label>
          <select id="grade-${id}" onchange="onChange(${id})">
            <option value="">â€” None / N/A â€”</option>
            ${gradeOpts}
          </select>
        </div>

        <!-- Colour (optional, spans 2 cols to fill the row) -->
        <div class="ef s2">
          <label class="el" for="color-${id}">Colour</label>
          <select id="color-${id}" onchange="onColor(${id})">
            <option value="">â€” Select â€”</option>
            ${colourOpts}
            <option value="Other">Other</option>
          </select>
          <!-- Free-text field shown when "Other" is picked -->
          <input type="text" id="color-other-${id}" class="other-inp" placeholder="Specify colourâ€¦"/>
        </div>

      </div><!-- /eg -->

      <!-- Row 2: Production & Dispatch quantities -->
      <div class="pd-row">

        <div class="pd-box prod">
          <label class="el" for="prod-${id}">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
            </svg>
            Production (Pieces)
          </label>
          <input type="number" id="prod-${id}" placeholder="0" min="0" oninput="onQty(${id})"/>
          <div class="pd-hint">Manufactured today</div>
        </div>

        <div class="pd-box disp">
          <label class="el" for="disp-${id}">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            </svg>
            Dispatch (Pieces)
          </label>
          <input type="number" id="disp-${id}" placeholder="0" min="0" oninput="onQty(${id})"/>
          <div class="pd-hint">Dispatched today</div>
        </div>

      </div><!-- /pd-row -->

      <!-- Sq. Ft. / Sq. Mtr. live conversion preview -->
      <div class="conv-box" id="conv-${id}"></div>

    </div><!-- /ec-body -->
  </div><!-- /ecard -->`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   REMOVE ENTRY
   Removes the card from DOM and state. Keeps at least 1 card.
   event.stopPropagation() prevents the header collapse from firing.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function removeEntry(event, id) {
  event.stopPropagation();
  if (entries.length === 1) { toast('At least one entry row is required.', 'err'); return; }
  card(id)?.remove();
  entries = entries.filter(e => e.id !== id);
  renumber();
  refreshCounters();
  refreshBatchBar();
}

/* Re-number the gold badge (1, 2, 3â€¦) after a removal */
function renumber() {
  entries.forEach((e, i) => {
    const el = $(`ecb-${e.id}`);
    if (el) el.textContent = i + 1;
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   COLLAPSE / EXPAND
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleCollapse(id) { card(id)?.classList.toggle('collapsed'); updateSummary(id); }
function collapseCard(id)   { card(id)?.classList.add('collapsed');    }
function expandCard(id)     { card(id)?.classList.remove('collapsed'); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FIELD CHANGE HANDLERS
   Each handler clears the relevant error, then calls onChange(id)
   which validates silently and refreshes the card state.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Machine selected â†’ repopulate Product dropdown */
function onMachine(id) {
  clearFErr(id, 'machine');
  const machine = val(`machine-${id}`);
  const pSel    = $(`product-${id}`);

  if (!machine) {
    pSel.innerHTML = '<option value="">â€” Select Machine First â€”</option>';
    pSel.disabled  = true;
    onChange(id);
    return;
  }

  const products = MACHINE_PRODUCTS[machine] || [];
  let html = '<option value="">â€” Select Product â€”</option>';
  products.forEach(p => { html += `<option value="${p}">${p}</option>`; });
  html += '<option value="__custom__">Other / Customâ€¦</option>';
  pSel.innerHTML = html;
  pSel.disabled  = false;
  onChange(id);
}

/** Product selected â€” handle custom entry via browser prompt */
function onProduct(id) {
  clearFErr(id, 'product');
  const sel = $(`product-${id}`);
  if (sel.value === '__custom__') {
    const name = prompt('Enter custom product name:');
    if (name?.trim()) {
      const opt = new Option(name.trim(), name.trim(), true, true);
      sel.add(opt); sel.value = name.trim();
    } else { sel.value = ''; }
  }
  onChange(id);
}

/** Thickness selected â€” toggle "Other" text input visibility */
function onThickness(id) {
  clearFErr(id, 'thickness');
  const isOther = val(`thickness-${id}`) === 'Other';
  $(`thick-other-${id}`).style.display = isOther ? 'block' : 'none';
  onChange(id);
}

/** Colour selected â€” toggle "Other" text input visibility */
function onColor(id) {
  const isOther = val(`color-${id}`) === 'Other';
  $(`color-other-${id}`).style.display = isOther ? 'block' : 'none';
  onChange(id);
}

/** Quantity changed â€” update conversion preview + card state */
function onQty(id) { updateConversion(id); onChange(id); }

/** Generic change handler: silent validation, summary, counters */
function onChange(id) {
  validateCard(id, true); // silent = true: no red error text
  updateSummary(id);
  refreshCounters();
  refreshBatchBar();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONVERSION PREVIEW
   Auto-computes Sq. Ft. and Sq. Mtr. using the CONV factors.
   Shown as a gold info box below the production/dispatch inputs.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateConversion(id) {
  const machine = val(`machine-${id}`);
  const product = val(`product-${id}`);
  const prod    = parseFloat(val(`prod-${id}`)) || 0;
  const disp    = parseFloat(val(`disp-${id}`)) || 0;
  const box     = $(`conv-${id}`);
  const factor  = CONV[`${machine}|${product}`];

  if (!factor || (!prod && !disp)) { box.classList.remove('show'); return; }

  const pSqft = prod > 0 ? +(prod / factor).toFixed(2) : null;
  const dSqft = disp > 0 ? +(disp / factor).toFixed(2) : null;
  const pSqm  = pSqft    ? +(pSqft * SQM_PER_SQFT).toFixed(3) : null;
  const dSqm  = dSqft    ? +(dSqft * SQM_PER_SQFT).toFixed(3) : null;

  let html = `<strong>ğŸ“ Conversion</strong> &nbsp;(${factor} pcs / sq ft)&emsp;`;
  if (pSqft) html += `Prod: <strong>${pSqft} sq ft</strong> / ${pSqm} sq mtr`;
  if (pSqft && dSqft) html += `&ensp;Â·&ensp;`;
  if (dSqft) html += `Disp: <strong>${dSqft} sq ft</strong> / ${dSqm} sq mtr`;

  box.innerHTML = html;
  box.classList.add('show');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CARD SUMMARY
   One-line text shown in the collapsed card header.
   E.g. "Apollo â€” Hexagon  60 MM Â· M-35 Â· Grey  â†‘120 â†“80"
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateSummary(id) {
  const machine = val(`machine-${id}`);
  const product = val(`product-${id}`);
  if (!machine || !product) {
    // Not enough data â€” show "New Entry" title only
    $(`ect-${id}`).style.display = '';
    $(`ecs-${id}`).style.display = 'none';
    return;
  }
  const thick = resolveThick(id);
  const grade = val(`grade-${id}`);
  const color = resolveColor(id);
  const prod  = parseFloat(val(`prod-${id}`)) || 0;
  const disp  = parseFloat(val(`disp-${id}`)) || 0;
  const meta  = [thick, grade, color].filter(Boolean).join(' Â· ');

  $(`ect-${id}`).style.display = 'none';
  $(`ecs-${id}`).style.display = '';
  $(`ecs-${id}`).innerHTML =
    `<b>${machine} â€” ${product}</b> <small>${meta}</small>` +
    `&ensp;<span class="lqp">â†‘${prod}</span>&ensp;<span class="lqd">â†“${disp}</span>`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CARD VALIDATION
   silent=true: just update the card's visual state (green/red border + dot)
                without showing inline error messages.
   silent=false: additionally show red error text under fields.
   Returns true if card passes all required checks.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function validateCard(id, silent = false) {
  const c       = card(id);
  const machine = val(`machine-${id}`);
  const product = val(`product-${id}`);
  const thick   = val(`thickness-${id}`);
  const prod    = parseFloat(val(`prod-${id}`)) || 0;
  const disp    = parseFloat(val(`disp-${id}`)) || 0;
  let ok = true;

  // Required: Machine
  if (!machine) {
    if (!silent) setFErr(id, 'machine', 'Required');
    ok = false;
  }
  // Required: Product
  if (!product) {
    if (!silent) setFErr(id, 'product', 'Required');
    ok = false;
  }
  // Required: Thickness (and "Other" value if selected)
  if (!thick) {
    if (!silent) setFErr(id, 'thickness', 'Required');
    ok = false;
  } else if (thick === 'Other' && !val(`thick-other-${id}`)) {
    if (!silent) setFErr(id, 'thickness', 'Please specify');
    ok = false;
  }
  // At least one non-zero quantity
  if (!prod && !disp) ok = false;

  // Update card CSS state
  if (ok) {
    c?.classList.remove('err');
    c?.classList.add('ok');
  } else {
    c?.classList.remove('ok');
    if (!silent) c?.classList.add('err');
  }

  // Persist validity in state array
  const entry = entries.find(e => e.id === id);
  if (entry) entry.valid = ok;

  return ok;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESOLVED FIELD VALUES
   Handle the "Other" free-text cases for Thickness and Colour.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resolveThick(id) {
  const s = val(`thickness-${id}`);
  return s === 'Other' ? val(`thick-other-${id}`) : s;
}
function resolveColor(id) {
  const s = val(`color-${id}`);
  return s === 'Other' ? val(`color-other-${id}`) : s;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ERROR HELPERS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setFErr(id, field, msg) {
  const errEl = $(`fe-${field}-${id}`);
  if (errEl) errEl.textContent = msg;
  $(`${field}-${id}`)?.classList.add('ferr');
}
function clearFErr(id, field) {
  const errEl = $(`fe-${field}-${id}`);
  if (errEl) errEl.textContent = '';
  $(`${field}-${id}`)?.classList.remove('ferr');
}
function clearAllErrors(id) {
  ['machine','product','thickness'].forEach(f => clearFErr(id, f));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   COUNTERS & BATCH BAR
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Refresh header count pill and section label count */
function refreshCounters() {
  const total = entries.length;
  const valid = entries.filter(e => e.valid).length;

  // Section count badge
  $('secCount').textContent = total;

  // Header pill
  const pill = $('hdrCount');
  if (total > 0) {
    pill.textContent = `${valid}/${total} ready`;
    pill.classList.add('show');
  } else {
    pill.classList.remove('show');
  }
}

/** Refresh the gold batch summary bar below the cards */
function refreshBatchBar() {
  const valid = entries.filter(e => e.valid);
  const bar   = $('batchBar');

  if (!valid.length) { bar.classList.remove('show'); return; }

  bar.classList.add('show');
  $('bbMain').textContent = `${valid.length} entr${valid.length > 1 ? 'ies' : 'y'} ready to submit`;

  // Aggregate totals across valid cards
  let totalProd = 0, totalDisp = 0;
  valid.forEach(e => {
    totalProd += parseFloat(val(`prod-${e.id}`)) || 0;
    totalDisp += parseFloat(val(`disp-${e.id}`)) || 0;
  });
  const date = $('batchDate').value;
  $('bbDetail').textContent =
    `Date: ${date}  Â·  Total Prod: ${totalProd} pcs  Â·  Total Disp: ${totalDisp} pcs`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BUILD ENTRY OBJECT
   Collects all field values from a card into a plain object that
   will be sent to the Google Apps Script endpoint.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildEntryObj(id) {
  const machine = val(`machine-${id}`);
  const product = val(`product-${id}`);
  const thick   = resolveThick(id);
  const color   = resolveColor(id);
  const grade   = val(`grade-${id}`);
  const prod    = parseFloat(val(`prod-${id}`)) || 0;
  const disp    = parseFloat(val(`disp-${id}`)) || 0;
  const factor  = CONV[`${machine}|${product}`] || null;

  return {
    date:       $('batchDate').value,
    machine, product,
    thickness:  thick,
    grade, color,
    production: prod,
    dispatch:   disp,
    sqftFactor: factor,
    // Pre-computed values (informational, also used by recalcRow in the script)
    prodSqft: factor && prod ? +(prod / factor).toFixed(4) : null,
    dispSqft: factor && disp ? +(disp / factor).toFixed(4) : null,
    prodSqm:  factor && prod ? +(prod / factor * SQM_PER_SQFT).toFixed(4) : null,
    dispSqm:  factor && disp ? +(disp / factor * SQM_PER_SQFT).toFixed(4) : null,
    timestamp: new Date().toISOString()
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SUBMIT ALL
   1. Runs full (non-silent) validation on every card.
   2. Expands any card with an error so the user can see it.
   3. Builds a batch array of entry objects.
   4. Sends to Google Apps Script as { batch: [...] }.
   5. Saves locally, resets form, refreshes log.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function submitAll() {

  // â”€â”€ Step 1: validate all cards (non-silent â†’ shows red error text) â”€â”€
  let allOk = true;
  entries.forEach(e => {
    clearAllErrors(e.id);
    const ok = validateCard(e.id, false);
    if (!ok) { allOk = false; expandCard(e.id); }
  });

  if (!allOk) {
    toast('Please fix the highlighted errors before submitting.', 'err');
    return;
  }

  // â”€â”€ Step 2: check at least one entry has a qty > 0 â”€â”€
  const hasQty = entries.some(e =>
    (parseFloat(val(`prod-${e.id}`)) || 0) > 0 ||
    (parseFloat(val(`disp-${e.id}`)) || 0) > 0
  );
  if (!hasQty) {
    toast('Enter at least one Production or Dispatch quantity.', 'err');
    return;
  }

  // â”€â”€ Step 3: build batch payload â”€â”€
  const batch      = entries.map(e => buildEntryObj(e.id));
  const btn        = $('btnSubmit');
  const scriptUrl  = localStorage.getItem('hipl_url');

  btn.disabled  = true;
  btn.innerHTML = '<span class="spin"></span> Submittingâ€¦';

  // Always save locally first (ensures offline history is complete)
  saveBatch(batch);

  // â”€â”€ Step 4a: no script configured â”€â”€
  if (!scriptUrl) {
    toast('Saved locally. Configure Google Sheets to sync.', 'inf');
    afterSubmit(btn);
    return;
  }

  // â”€â”€ Step 4b: offline â”€â”€
  if (!navigator.onLine) {
    queueOffline(batch);
    toast('Offline â€” batch queued, will sync when reconnected.', 'inf');
    afterSubmit(btn);
    return;
  }

  // â”€â”€ Step 4c: send to Google Apps Script â”€â”€
  //
  // IMPORTANT â€” why mode:'no-cors' and how it works:
  //
  // Apps Script does NOT return CORS headers (Access-Control-Allow-Origin).
  // A normal fetch() would be blocked by the browser with a CORS error
  // *even if the data was written to the sheet successfully*.
  //
  // With mode:'no-cors':
  //   - The browser sends the request and DOES deliver it to Google
  //   - We get back an "opaque" response (we can't read it)
  //   - fetch() only THROWS if there is a genuine network failure:
  //       â€¢ No internet connection
  //       â€¢ DNS cannot resolve script.google.com
  //       â€¢ Request blocked by firewall / VPN
  //   - If fetch() resolves without throwing â†’ the request reached Google âœ“
  //
  // Content-Type must be 'text/plain' â€” any other type triggers
  // a CORS preflight (OPTIONS request) which Apps Script rejects.
  try {
    await fetch(scriptUrl, {
      method:  'POST',
      mode:    'no-cors',                           // opaque response â€” expected
      headers: { 'Content-Type': 'text/plain' },   // simple request â€” no preflight
      body:    JSON.stringify({ batch })
    });
    // If we reach here, the request was sent successfully
    toast(`âœ“ ${batch.length} entr${batch.length > 1 ? 'ies' : 'y'} submitted to Google Sheets!`, 'ok');
  } catch (err) {
    // Only reaches here on genuine network failure (no internet etc.)
    console.error('HIPL submit error:', err.message);
    queueOffline(batch);
    toast('No internet connection â€” saved locally, will sync when back online.', 'inf');
  }

  afterSubmit(btn);
}

/** Reset state after a submit (success or offline queue) */
function afterSubmit(btn) {
  btn.disabled  = false;
  btn.innerHTML = 'Submit All Entries';
  renderLog();
  // Reset: clear all current cards and start fresh with one blank card
  entries = [];
  nextId  = 0;
  $('entryCards').innerHTML = '';
  addEntry();
  refreshBatchBar();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CLEAR ALL
   If only 1 card: resets its fields.
   If multiple: confirms then removes all, adds a fresh blank.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function clearAll() {
  if (entries.length === 1) { resetCard(entries[0].id); return; }
  if (!confirm(`Clear all ${entries.length} entries?`)) return;
  entries = [];
  nextId  = 0;
  $('entryCards').innerHTML = '';
  addEntry();
  refreshBatchBar();
}

/** Reset an individual card to blank state without removing it */
function resetCard(id) {
  ['machine','product','thickness','grade','color'].forEach(f => {
    const el = $(`${f}-${id}`);
    if (el) { el.value = ''; }
  });
  $(`product-${id}`).innerHTML = '<option value="">â€” Select Machine First â€”</option>';
  $(`product-${id}`).disabled  = true;
  $(`prod-${id}`).value        = '';
  $(`disp-${id}`).value        = '';
  $(`thick-other-${id}`).style.display = 'none';
  $(`color-other-${id}`).style.display = 'none';
  $(`conv-${id}`).classList.remove('show');
  card(id)?.classList.remove('ok','err');
  entries.forEach(e => { if (e.id === id) e.valid = false; });
  updateSummary(id);
  refreshCounters();
  refreshBatchBar();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOCAL STORAGE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/** Save a submitted batch to the "hipl_batches" history in localStorage */
function saveBatch(batch) {
  const history = JSON.parse(localStorage.getItem('hipl_batches') || '[]');
  history.unshift({
    submittedAt: new Date().toISOString(),
    date:        $('batchDate').value,
    entries:     batch
  });
  if (history.length > 20) history.splice(20); // keep last 20 batches
  localStorage.setItem('hipl_batches', JSON.stringify(history));
}

/** Push a failed/offline batch onto the retry queue */
function queueOffline(batch) {
  const q = JSON.parse(localStorage.getItem('hipl_queue') || '[]');
  q.push({ batch, queuedAt: new Date().toISOString() });
  localStorage.setItem('hipl_queue', JSON.stringify(q));
}

/** Attempt to flush the offline queue when connectivity is restored */
async function syncQueue() {
  const url = localStorage.getItem('hipl_url');
  if (!url) return;
  const q = JSON.parse(localStorage.getItem('hipl_queue') || '[]');
  if (!q.length) return;

  toast(`Syncing ${q.length} queued batch${q.length > 1 ? 'es' : ''}â€¦`, 'inf');
  const failed = [];

  for (const item of q) {
    try {
      await fetch(url, {
        method:  'POST',
        mode:    'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body:    JSON.stringify({ batch: item.batch })
      });
      // no-cors resolves without throwing = request delivered successfully
    } catch (e) { console.error('Sync error:', e.message); failed.push(item); }
  }

  localStorage.setItem('hipl_queue', JSON.stringify(failed));
  const done = q.length - failed.length;
  if (done > 0) toast(`âœ“ ${done} batch${done > 1 ? 'es' : ''} synced to Google Sheets!`, 'ok');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RECENT SUBMISSIONS LOG
   Renders the last 8 batches from localStorage into the log section.
   Each batch shows: date, count, and a row per entry.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderLog() {
  const history = JSON.parse(localStorage.getItem('hipl_batches') || '[]');
  const list    = $('logList');

  if (!history.length) {
    list.innerHTML = '<div class="log-empty">No submissions yet â€” submit your first batch above.</div>';
    return;
  }

  list.innerHTML = history.slice(0, 8).map(b => {
    const d       = new Date(b.submittedAt);
    const timeStr = d.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
    const dateStr = new Date(b.date).toLocaleDateString('en-IN', {
      weekday:'short', day:'numeric', month:'short'
    });
    const rows = b.entries.map(e => `
      <div class="log-row">
        <span class="log-machine">${e.machine.split(' ')[0]}</span>
        <div class="log-info">
          <b>${e.product}</b>
          <span>${[e.thickness, e.grade, e.color].filter(Boolean).join(' Â· ')}</span>
        </div>
        <div class="log-qty">
          <span class="lqp">â†‘${e.production}</span>
          <span style="color:rgba(255,255,255,0.18)">|</span>
          <span class="lqd">â†“${e.dispatch}</span>
        </div>
      </div>`).join('');

    return `
      <div class="log-batch">
        <div class="log-batch-hdr">
          <span class="lbh-date">${dateStr}</span>
          <span class="lbh-count">${b.entries.length} entr${b.entries.length > 1 ? 'ies' : 'y'}</span>
          <span class="lbh-time">${timeStr}</span>
        </div>
        ${rows}
      </div>`;
  }).join('');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SETTINGS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleCfg() {
  $('cfgToggle').classList.toggle('open');
  $('cfgPanel').classList.toggle('open');
}
function saveSettings() {
  const url = $('scriptUrl').value.trim();
  localStorage.setItem('hipl_url', url);
  updateCfgStatus();
  toast('âœ“ Settings saved!', 'ok');
}
function updateCfgStatus() {
  const el  = $('cfgStatus');
  const url = localStorage.getItem('hipl_url') || '';
  el.textContent = url ? 'ğŸŸ¢ Connected' : 'ğŸ”´ Not configured';
  el.style.color = url ? '#68D391' : '#FC8181';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TEST CONNECTION
   Hits the Apps Script URL with a GET request so we get a real
   HTTP response and can tell the user exactly what went wrong.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function testConnection() {
  const url = $('scriptUrl').value.trim();

  if (!url) {
    showTestResult('error', 'âŒ No URL entered. Paste your Web App URL above first.');
    return;
  }
  if (!url.startsWith('https://script.google.com/macros/s/')) {
    showTestResult('error',
      'âŒ <strong>URL looks wrong.</strong><br>' +
      'It must start with: <code style="background:rgba(0,0,0,0.3);padding:1px 5px;border-radius:3px;">https://script.google.com/macros/s/</code><br>' +
      'Copy it from: Apps Script â†’ Deploy â†’ Manage Deployments â†’ your active deployment â†’ the URL column.'
    );
    return;
  }

  const btn = $('btnTest');
  btn.textContent = 'Testingâ€¦';
  btn.disabled = true;
  showTestResult('info', 'ğŸ”Œ Connecting to Google Apps Script via JSONPâ€¦');

  // â”€â”€ JSONP approach â”€â”€
  // Regular fetch() is blocked by CORS when the page is opened as file://
  // or from some hosting environments. JSONP works around this:
  // we inject a <script> tag pointing to the Apps Script URL with a
  // callback parameter. Apps Script wraps its JSON response in the
  // callback function name, and our globally-defined function receives it.
  // This works from file://, GitHub Pages, anywhere â€” no CORS restriction.

  // Unique callback name to avoid conflicts if test is clicked multiple times
  const cbName = 'hipl_test_cb_' + Date.now();
  let timeoutId;

  // Clean up: remove script tag and global callback after we're done
  const cleanup = () => {
    const s = $('jsonp-test-script');
    if (s) s.remove();
    delete window[cbName];
    clearTimeout(timeoutId);
    btn.textContent = 'ğŸ”Œ Test Connection';
    btn.disabled = false;
  };

  // This function will be called by the script tag response
  window[cbName] = function(data) {
    cleanup();
    if (data && data.status === 'ok') {
      showTestResult('success',
        'âœ… <strong>Connection successful!</strong><br>' +
        'Apps Script is deployed and responding correctly.<br>' +
        'Submissions will sync to Google Sheets. You're all set!'
      );
    } else {
      showTestResult('error',
        'âš ï¸ <strong>Script responded but with unexpected data:</strong><br>' +
        JSON.stringify(data) + '<br>' +
        'Make sure you deployed the latest version of the Apps Script.'
      );
    }
  };

  // Timeout: if the script tag doesn't call our callback within 12s, it failed
  timeoutId = setTimeout(() => {
    cleanup();
    // Check if it might be a permissions/deployment issue by opening in new tab
    showTestResult('error',
      'âŒ <strong>No response from Apps Script (timed out)</strong><br><br>' +
      '<strong>Step 1 â€” Open this URL in a new browser tab:</strong><br>' +
      '<a href="' + url + '" target="_blank" style="color:#68D391;word-break:break-all;">' + url + '</a><br><br>' +
      'What do you see?<br>' +
      '&nbsp;Â· If it asks you to <strong>log in to Google</strong> â†’ re-deploy with <em>"Anyone with Google Account"</em> access<br>' +
      '&nbsp;Â· If it shows <strong>{"status":"ok"}</strong> â†’ the script is fine, submission should work<br>' +
      '&nbsp;Â· If it shows a <strong>Google error page</strong> â†’ create a New Deployment and paste the new URL<br>' +
      '&nbsp;Â· If it shows <strong>nothing / blank</strong> â†’ the script code may have an error; check Apps Script editor for red error markers'
    );
  }, 12000);

  // Inject the script tag â€” browser fetches it like a regular script (no CORS)
  const script = document.createElement('script');
  script.id  = 'jsonp-test-script';
  script.src = url + '?callback=' + cbName;
  script.onerror = () => {
    cleanup();
    showTestResult('error',
      'âŒ <strong>Could not load the Apps Script URL</strong><br><br>' +
      'Most likely causes:<br>' +
      '&nbsp;Â· The script has <strong>never been deployed</strong> as a Web App yet<br>' +
      '&nbsp;Â· The deployment was deleted or the URL is outdated<br>' +
      '&nbsp;Â· There is a syntax error in the Apps Script code<br><br>' +
      '<strong>Fix:</strong> In your Google Sheet â†’ Extensions â†’ Apps Script â†’ Deploy â†’ <strong>New Deployment</strong> â†’ Web App<br>' +
      'Execute as: <strong>Me</strong> Â· Who has access: <strong>Anyone with Google Account</strong><br>' +
      'Then copy the new URL here and save settings.'
    );
  };
  document.head.appendChild(script);
}

function showTestResult(type, html) {
  const box = $('testResult');
  const styles = {
    success: 'background:rgba(56,161,105,0.12);border:1px solid rgba(56,161,105,0.3);color:#9AE6B4;',
    error:   'background:rgba(229,62,62,0.1);border:1px solid rgba(229,62,62,0.3);color:#FC8181;',
    info:    'background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.25);color:#F5A623;'
  };
  box.style.cssText = styles[type] + 'display:block;border-radius:7px;padding:11px 14px;font-size:12px;line-height:1.8;margin-top:2px;';
  box.innerHTML = html;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOAST NOTIFICATIONS
   type: 'ok' (green) | 'err' (red) | 'inf' (gold pulsing)
   Auto-dismiss after 3.8 s with a fade-out.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, type = 'ok') {
  const wrap = $('toastWrap');
  const el   = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<div class="t-dot"></div><span>${msg}</span>`;
  wrap.appendChild(el);
  setTimeout(() => {
    el.style.opacity    = '0';
    el.style.transition = 'opacity .3s';
    setTimeout(() => el.remove(), 300);
  }, 3800);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MODAL â€” Google Apps Script viewer
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openModal()  { $('scriptPre').textContent = APPS_SCRIPT; $('scriptModal').classList.add('open'); }
function closeModal() { $('scriptModal').classList.remove('open'); }
function copyScript() {
  navigator.clipboard.writeText(APPS_SCRIPT)
    .then(() => toast('âœ“ Script copied to clipboard!', 'ok'));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOOGLE APPS SCRIPT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Paste this into: Google Sheet â†’ Extensions â†’ Apps Script
   Then: Deploy â†’ New Deployment â†’ Web App
         Execute as: Me
         Who has access: Anyone with Google Account
   Copy the Web App URL into the Settings panel in this app.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const APPS_SCRIPT = `// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HIPL Production & Dispatch Tracker â€” Google Apps Script v3
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DEPLOYMENT:
//   Extensions â†’ Apps Script â†’ Paste â†’ Save â†’ Deploy â†’ New Deployment â†’ Web App
//   Execute as: Me  |  Who has access: Anyone with Google Account
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Column index constants (1-based, for Google Sheets) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COL = {
  MACHINE:   1,  // A â€” Machine Name
  PRODUCT:   2,  // B â€” Product
  THICKNESS: 3,  // C â€” Thickness
  GRADE:     4,  // D â€” Grade
  COLOR:     5,  // E â€” Colour
  OPENING:   6,  // F â€” Opening Stock
  // Columns 7+ = date pairs (Prod at G/I/Kâ€¦, Disp at H/J/Lâ€¦)
  // Last 5 columns always = TP | TD | Closing | Sq.Ft. | Sq.Mtr.
};

const TOTAL_COLS      = 5;  // TP, TD, Closing, Sq.Ft., Sq.Mtr. â€” always last
const FIRST_DATE_COL  = 7;  // Date-pair columns begin here

// Insertion sort order for machines
const MACHINE_ORDER = ['Apollo','Parijatha PBM+','Rubber Mould','Columbia','Other'];

// Sheet tab naming: Jan-26, Feb-26, etc.
const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun',
                     'Jul','Aug','Sep','Oct','Nov','Dec'];

// â”€â”€ HTTP Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * doPost
 * Receives a JSON body posted as text/plain (to avoid CORS preflight).
 * The body is still valid JSON â€” we parse e.postData.contents directly.
 * Accepts both { batch: [...entries] } and a single entry object.
 * A ScriptLock prevents concurrent write conflicts from multiple users.
 */
function doPost(e) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const payload  = JSON.parse(e.postData.contents);
    const entries  = payload.batch ? payload.batch : [payload];
    const results  = entries.map(entry => processEntry(entry));
    return jsonResp({ status:'ok', processed: results.length, results });
  } catch(err) {
    return jsonResp({ status:'error', message: err.toString() });
  } finally {
    lock.releaseLock();
  }
}

/** doGet: health check + JSONP support for the Test Connection button.
 *  When called with ?callback=fnName, wraps response in fnName({...})
 *  so the browser can receive it cross-origin without CORS restrictions.
 */
function doGet(e) {
  const data     = { status: 'ok', app: 'HIPL Tracker', version: '3.0' };
  const callback = e && e.parameter && e.parameter.callback;
  if (callback) {
    // JSONP response â€” wrap JSON in the callback function name
    return ContentService
      .createTextOutput(callback + '(' + JSON.stringify(data) + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return jsonResp(data);
}

function jsonResp(obj) {
  // Add CORS headers so the browser can read the response from our fetch() call
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/** doOptions: handle CORS preflight if browser sends one */
function doOptions(e) {
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT);
}

// â”€â”€ Core: Process One Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * processEntry
 * 1. Finds or creates the correct monthly sheet.
 * 2. Ensures a date column pair exists for data.date.
 * 3. Finds or creates a data row matching the 5-field key.
 * 4. Writes Prod / Disp values (overwrite mode).
 * 5. Recalculates TP, TD, Closing, Sq.Ft., Sq.Mtr. for that row.
 */
function processEntry(data) {
  const ss   = SpreadsheetApp.getActiveSpreadsheet();
  const date = new Date(data.date);

  // 1. Monthly sheet
  const sheetName = getSheetName(date);
  let sheet = ss.getSheetByName(sheetName);
  if (!sheet) sheet = createMonthlySheet(ss, sheetName, date);

  // 2. Date columns
  const { prod: prodCol, disp: dispCol } = getOrCreateDateColumn(sheet, date);

  // 3. Find or create data row
  const rowIdx = findRow(sheet, data);

  if (rowIdx > 0) {
    // Overwrite existing Prod/Disp for this date
    if (data.production > 0) sheet.getRange(rowIdx, prodCol).setValue(data.production);
    if (data.dispatch   > 0) sheet.getRange(rowIdx, dispCol).setValue(data.dispatch);
    recalcRow(sheet, rowIdx);
    return { status:'updated', row:rowIdx, sheet:sheetName };
  } else {
    // Insert new row at sorted position
    const insertAt = findInsertPos(sheet, data);
    sheet.insertRowBefore(insertAt);

    sheet.getRange(insertAt, COL.MACHINE).setValue(data.machine    || '');
    sheet.getRange(insertAt, COL.PRODUCT).setValue(data.product    || '');
    sheet.getRange(insertAt, COL.THICKNESS).setValue(data.thickness || '');
    sheet.getRange(insertAt, COL.GRADE).setValue(data.grade        || '');
    sheet.getRange(insertAt, COL.COLOR).setValue(data.color        || '');
    sheet.getRange(insertAt, COL.OPENING).setValue(0);

    sheet.getRange(insertAt, prodCol).setValue(data.production || 0);
    sheet.getRange(insertAt, dispCol).setValue(data.dispatch   || 0);

    recalcRow(sheet, insertAt);
    styleDataRow(sheet, insertAt);
    return { status:'created', row:insertAt, sheet:sheetName };
  }
}

// â”€â”€ Row Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * findRow: scans rows 3+ for a row where all 5 key fields match.
 * Comparison is case-insensitive and whitespace-trimmed.
 * Returns 1-based row index or -1 if not found.
 */
function findRow(sheet, data) {
  const last = sheet.getLastRow();
  if (last < 3) return -1;
  const vals = sheet.getRange(3, 1, last - 2, 5).getValues();
  for (let i = 0; i < vals.length; i++) {
    if (
      norm(vals[i][0]) === norm(data.machine)    &&
      norm(vals[i][1]) === norm(data.product)    &&
      norm(vals[i][2]) === norm(data.thickness)  &&
      norm(vals[i][3]) === norm(data.grade || '') &&
      norm(vals[i][4]) === norm(data.color || '')
    ) return i + 3;
  }
  return -1;
}

const norm = s => String(s || '').trim().toLowerCase();

// â”€â”€ Insert Position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * findInsertPos: find where to insert a new row.
 * Sort order: machine order index first, then product name alphabetically.
 */
function findInsertPos(sheet, data) {
  const last = sheet.getLastRow();
  if (last < 3) return 3;
  const vals = sheet.getRange(3, 1, last - 2, 2).getValues();
  const newMi = machIdx(data.machine);
  for (let i = 0; i < vals.length; i++) {
    const rowMi = machIdx(String(vals[i][0]));
    if (rowMi > newMi) return i + 3;
    if (rowMi === newMi && norm(String(vals[i][1])) > norm(data.product)) return i + 3;
  }
  return last + 1;
}

function machIdx(m) { const i = MACHINE_ORDER.indexOf(m); return i === -1 ? 99 : i; }

// â”€â”€ Date Columns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * getOrCreateDateColumn
 * Finds an existing Prod column for the given date, or inserts a new
 * Prod|Disp pair just before the trailing summary columns.
 * Returns { prod: colIdx, disp: colIdx+1 }.
 */
function getOrCreateDateColumn(sheet, date) {
  const lastCol = sheet.getLastColumn();
  if (lastCol < FIRST_DATE_COL) return insertDateCols(sheet, date);

  const row1   = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  const target = date.toDateString();

  for (let c = FIRST_DATE_COL; c <= lastCol - TOTAL_COLS; c += 2) {
    const cell = row1[c - 1];
    if (cell instanceof Date && cell.toDateString() === target) return { prod:c, disp:c+1 };
  }
  return insertDateCols(sheet, date);
}

function insertDateCols(sheet, date) {
  const lastCol  = sheet.getLastColumn();
  const at       = lastCol - TOTAL_COLS + 1; // before TP

  sheet.insertColumnsBefore(at, 2);

  // Merge date header across Prod+Disp columns
  const dateHdr = sheet.getRange(1, at, 1, 2);
  dateHdr.merge();
  dateHdr.setValue(date);
  dateHdr.setNumberFormat('dd-mmm-yy');
  dateHdr.setHorizontalAlignment('center');
  styleHdr(dateHdr, '#2D3B52', '#F5A623');

  // Sub-headers
  styleHdr(sheet.getRange(2, at),   '#1E2A3A', '#68D391');
  styleHdr(sheet.getRange(2, at+1), '#1E2A3A', '#FC8181');
  sheet.getRange(2, at).setValue('Prod');
  sheet.getRange(2, at+1).setValue('Disp');
  sheet.setColumnWidth(at,   70);
  sheet.setColumnWidth(at+1, 70);

  return { prod:at, disp:at+1 };
}

// â”€â”€ Recalculate Row Totals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * recalcRow
 * Sums all Prod and Disp values across all date columns for a row.
 * Writes TP, TD, Closing = Opening + TP - TD.
 * If a conversion factor exists, also writes Sq.Ft. and Sq.Mtr.
 */
function recalcRow(sheet, rowIdx) {
  const lastCol  = sheet.getLastColumn();
  const pairLen  = lastCol - FIRST_DATE_COL - TOTAL_COLS + 1;
  if (pairLen <= 0) return;

  const rowVals = sheet.getRange(rowIdx, FIRST_DATE_COL, 1, pairLen).getValues()[0];
  let tp = 0, td = 0;
  for (let i = 0; i < rowVals.length; i += 2) {
    tp += Number(rowVals[i])     || 0;
    td += Number(rowVals[i + 1]) || 0;
  }

  const opening  = Number(sheet.getRange(rowIdx, COL.OPENING).getValue()) || 0;
  const closing  = opening + tp - td;

  // Positions of trailing summary columns
  const tpCol      = lastCol - TOTAL_COLS + 1;
  const tdCol      = tpCol + 1;
  const closingCol = tpCol + 2;
  const sqftCol    = tpCol + 3;
  const sqmCol     = tpCol + 4;

  sheet.getRange(rowIdx, tpCol).setValue(tp);
  sheet.getRange(rowIdx, tdCol).setValue(td);
  sheet.getRange(rowIdx, closingCol).setValue(closing);

  // Sq. Ft. / Sq. Mtr. â€” based on closing stock and conversion factor
  const machine = sheet.getRange(rowIdx, COL.MACHINE).getValue();
  const product = sheet.getRange(rowIdx, COL.PRODUCT).getValue();
  const factor  = CONV_FACTORS[machine + '|' + product];
  if (factor && closing >= 0) {
    const sqft = closing / factor;
    sheet.getRange(rowIdx, sqftCol).setValue(+sqft.toFixed(4));
    sheet.getRange(rowIdx, sqmCol).setValue(+(sqft * 0.092903).toFixed(4));
  }
  // No factor â†’ leave Sq.Ft. and Sq.Mtr. blank
}

// â”€â”€ Conversion factors (mirrors the frontend CONV object exactly) â”€
const CONV_FACTORS = {
  'Apollo|Hexagon':              2.50,
  'Apollo|8x8 Quad':             2.25,
  'Apollo|8x4':                  4.50,
  'Apollo|Kerbstone Round':      1.00,
  'Apollo|Kerbstone Chamfered':  1.00,
  'Apollo|Kerbstone Bullnose':   1.00,
  'Parijatha PBM+|Hexagon':      2.50,
  'Parijatha PBM+|Zigzag':       3.50,
  'Parijatha PBM+|I-Shape':      3.25,
  'Parijatha PBM+|8x4':          4.50,
  'Parijatha PBM+|Tricon':       2.90,
  'Parijatha PBM+|S-Paver':      4.50,
  'Rubber Mould|Jumbo':          1.80,
  'Rubber Mould|Zigzag':         2.80,
  'Rubber Mould|Euphrates':      2.50,
  'Rubber Mould|River Quad':     2.25,
  'Rubber Mould|3D Hexa':        2.50,
  'Rubber Mould|Cobble':         2.25,
  'Rubber Mould|8x4':            4.50,
  'Rubber Mould|4x4':            9.00,
  'Rubber Mould|Cobble 4.5"':    7.11,
  'Rubber Mould|X-Block':        1.44,
  'Rubber Mould|36 Striker':     1.00,
  'Rubber Mould|Cross Strip':    1.00,
  'Rubber Mould|Matrix':         1.00,
  'Rubber Mould|BB Bali':        2.25,
  'Rubber Mould|BB Aruba':       2.25,
  'Rubber Mould|BB Maui':        2.25,
  'Rubber Mould|BB Maldives':    2.25,
  'Rubber Mould|BB Ibiza':       2.25,
  'Rubber Mould|BB Barbados':    2.25,
  'Rubber Mould|Cool Roof Tile': 1.00,
  'Rubber Mould|Drain Channel':  1.00,
};

// â”€â”€ Monthly Sheet Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Returns the sheet name for a date, e.g. "Feb-26" */
function getSheetName(date) {
  return MONTH_NAMES[date.getMonth()] + '-' + String(date.getFullYear()).slice(2);
}

/**
 * createMonthlySheet
 * Inserts a new sheet at position 0 (leftmost tab).
 * If a previous month's sheet exists, copies all rows and carries
 * Closing Stock â†’ Opening Stock for the new month.
 * If no previous month, sets up blank headers only.
 */
function createMonthlySheet(ss, sheetName, date) {
  const newSheet  = ss.insertSheet(sheetName, 0);
  const prevName  = getPrevMonthName(date);
  const prevSheet = ss.getSheetByName(prevName);

  if (prevSheet) {
    copyFromPrevMonth(newSheet, prevSheet);
  } else {
    setupHeaders(newSheet);
  }
  return newSheet;
}

function getPrevMonthName(date) {
  const d = new Date(date.getFullYear(), date.getMonth() - 1, 1);
  return MONTH_NAMES[d.getMonth()] + '-' + String(d.getFullYear()).slice(2);
}

/**
 * copyFromPrevMonth
 * Copies every data row from the previous month's sheet.
 * Sets Opening Stock = previous month's Closing Stock for each row.
 * All rows are copied regardless of their closing stock value.
 */
function copyFromPrevMonth(newSheet, prevSheet) {
  const prevLast    = prevSheet.getLastRow();
  const prevLastCol = prevSheet.getLastColumn();
  setupHeaders(newSheet);
  if (prevLast < 3) return;

  const rowCount  = prevLast - 2;
  const idCols    = prevSheet.getRange(3, 1, rowCount, 6).getValues();

  // Closing is at prevLastCol - TOTAL_COLS + 3 (= TP, TD, Closing, SqFt, SqMtr)
  const closingCol = prevLastCol - TOTAL_COLS + 3;
  let closingVals  = [];
  if (closingCol >= 1 && closingCol <= prevLastCol) {
    closingVals = prevSheet.getRange(3, closingCol, rowCount, 1)
      .getValues().map(r => Number(r[0]) || 0);
  }

  for (let i = 0; i < rowCount; i++) {
    const row     = i + 3;
    const id      = idCols[i];
    const opening = closingVals[i] !== undefined ? closingVals[i] : 0;

    newSheet.getRange(row, COL.MACHINE).setValue(id[0]    || '');
    newSheet.getRange(row, COL.PRODUCT).setValue(id[1]    || '');
    newSheet.getRange(row, COL.THICKNESS).setValue(id[2]  || '');
    newSheet.getRange(row, COL.GRADE).setValue(id[3]      || '');
    newSheet.getRange(row, COL.COLOR).setValue(id[4]      || '');
    newSheet.getRange(row, COL.OPENING).setValue(opening); // â† carry-forward
  }
  styleDataRows(newSheet, 3, rowCount);
}

// â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * setupHeaders: writes row 2 fixed-column headers + trailing summary headers.
 * Sets column widths and freezes first 2 rows + 6 columns.
 */
function setupHeaders(sheet) {
  const fixed   = ['Machine Name','Product','Thickness','Grade','Colour','Opening'];
  const summary = ['TP','TD','Closing','Sq. Ft.','Sq. Mtr.'];

  fixed.forEach((h,i) => {
    const c = sheet.getRange(2, i+1);
    c.setValue(h); styleHdr(c, '#111923', '#F5A623');
  });
  summary.forEach((h,i) => {
    const c = sheet.getRange(2, 7+i);
    c.setValue(h); styleHdr(c, '#111923', '#F5A623');
  });

  sheet.setColumnWidth(1, 145);  // Machine
  sheet.setColumnWidth(2, 145);  // Product
  sheet.setColumnWidth(3,  90);  // Thickness
  sheet.setColumnWidth(4,  70);  // Grade
  sheet.setColumnWidth(5,  95);  // Colour
  sheet.setColumnWidth(6,  80);  // Opening

  sheet.setFrozenRows(2);
  sheet.setFrozenColumns(6);
}

function styleHdr(range, bg, fg) {
  range.setBackground(bg);
  range.setFontColor(fg);
  range.setFontWeight('bold');
  range.setHorizontalAlignment('center');
}

/** Alternating row background shading for a block of data rows */
function styleDataRows(sheet, startRow, count) {
  for (let i = 0; i < count; i++) {
    const bg = i % 2 === 0 ? '#1E2A3A' : '#243044';
    sheet.getRange(startRow + i, 1, 1, Math.max(sheet.getLastColumn(), 11)).setBackground(bg);
  }
}

/** Shade a single newly-inserted data row */
function styleDataRow(sheet, rowIdx) {
  const idx = rowIdx - 3;
  const bg  = idx % 2 === 0 ? '#1E2A3A' : '#243044';
  sheet.getRange(rowIdx, 1, 1, sheet.getLastColumn()).setBackground(bg);
}`;
</script>
</body>
</html>
